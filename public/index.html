<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Report Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0a0c0f;
    --bg2:       #0f1318;
    --bg3:       #151a22;
    --bg4:       #1c2330;
    --border:    #1f2a38;
    --border2:   #263344;
    --text:      #e2e8f0;
    --muted:     #64748b;
    --muted2:    #94a3b8;
    --accent:    #3b82f6;
    --accent2:   #60a5fa;
    --green:     #22c55e;
    --yellow:    #eab308;
    --red:       #ef4444;
    --purple:    #a855f7;
    --cyan:      #06b6d4;
    --orange:    #f97316;
    --card-glow: 0 0 0 1px var(--border), 0 4px 24px rgba(0,0,0,0.4);
  }

  /* â”€â”€ LIGHT THEME â”€â”€ */
  body.light {
    --bg:      #f1f5f9;
    --bg2:     #ffffff;
    --bg3:     #f8fafc;
    --bg4:     #e2e8f0;
    --border:  #e2e8f0;
    --border2: #cbd5e1;
    --text:    #0f172a;
    --muted:   #94a3b8;
    --muted2:  #64748b;
    --accent2: #2563eb;
  }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  .app { display: flex; min-height: 100vh; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar {
    width: 220px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px 0;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }
  .logo {
    padding: 0 24px 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .logo-mark {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .logo-mark span { color: var(--accent); }
  .logo-sub { font-size: 10px; color: var(--muted); margin-top: 2px; letter-spacing: 1px; text-transform: uppercase; }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 24px;
    color: var(--muted);
    cursor: pointer;
    transition: all .15s;
    font-size: 12px;
    letter-spacing: .3px;
    border-left: 2px solid transparent;
  }
  .nav-item:hover { color: var(--text); background: var(--bg3); }
  .nav-item.active { color: var(--accent2); border-left-color: var(--accent); background: rgba(59,130,246,.06); }
  .nav-icon { width: 16px; height: 16px; opacity: .7; }
  .nav-item.active .nav-icon { opacity: 1; }

  .sidebar-footer {
    margin-top: auto;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
  }
  .sync-btn {
    width: 100%;
    background: rgba(59,130,246,.1);
    border: 1px solid rgba(59,130,246,.25);
    color: var(--accent2);
    padding: 8px 12px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: .5px;
    transition: all .2s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }
  .sync-btn:hover { background: rgba(59,130,246,.18); }
  .sync-btn.syncing .sync-icon { animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .last-sync { font-size: 10px; color: var(--muted); text-align: center; margin-top: 8px; }

  /* â”€â”€ MAIN â”€â”€ */
  .main {
    margin-left: 220px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .topbar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 50;
  }
  .page-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: -.3px; }
  .page-date { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .date-nav { display: flex; align-items: center; gap: 8px; }
  .date-nav button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--muted2);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .date-nav button:hover { border-color: var(--accent); color: var(--accent2); }
  .date-label { font-size: 12px; color: var(--text); min-width: 100px; text-align: center; }

  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: rgba(34,197,94,.1);
    border: 1px solid rgba(34,197,94,.2);
    color: var(--green);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 10px;
    letter-spacing: .5px;
  }
  .badge-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€ CONTENT â”€â”€ */
  .content { padding: 28px 32px; flex: 1; }

  /* â”€â”€ STAT ROW â”€â”€ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color .2s;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.blue::before  { background: var(--accent); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.yellow::before{ background: var(--yellow); }
  .stat-card.purple::before{ background: var(--purple); }
  .stat-card:hover { border-color: var(--border2); }

  .stat-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 28px; letter-spacing: -1px; }
  .stat-value.blue   { color: var(--accent2); }
  .stat-value.green  { color: var(--green); }
  .stat-value.yellow { color: var(--yellow); }
  .stat-value.purple { color: var(--purple); }
  .stat-sub { font-size: 10px; color: var(--muted); margin-top: 4px; }

  /* â”€â”€ GRID â”€â”€ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .grid-3 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }

  /* â”€â”€ CARD â”€â”€ */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    display: flex; align-items: center; gap: 8px;
  }
  .card-title .dot {
    width: 8px; height: 8px; border-radius: 50%;
  }
  .card-count {
    font-size: 11px;
    color: var(--muted);
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 2px 8px;
    border-radius: 12px;
  }
  .card-body { padding: 0; }

  /* â”€â”€ JIRA ISSUES â”€â”€ */
  .issue-row {
    display: flex; align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
    cursor: pointer;
    transition: background .12s;
  }
  .issue-row:last-child { border-bottom: none; }
  .issue-row:hover { background: var(--bg3); }

  .issue-key {
    font-size: 11px;
    color: var(--accent2);
    font-weight: 500;
    min-width: 70px;
    letter-spacing: .3px;
  }
  .issue-summary { flex: 1; color: var(--text); font-size: 12px; }
  .issue-project { font-size: 10px; color: var(--muted); }

  .status-pill {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
    white-space: nowrap;
    letter-spacing: .3px;
  }
  .status-progress { background: rgba(59,130,246,.15); color: var(--accent2); border: 1px solid rgba(59,130,246,.3); }
  .status-review   { background: rgba(168,85,247,.15); color: var(--purple);  border: 1px solid rgba(168,85,247,.3); }
  .status-todo     { background: rgba(100,116,139,.12); color: var(--muted2); border: 1px solid rgba(100,116,139,.25); }
  .status-done     { background: rgba(34,197,94,.12);  color: var(--green);  border: 1px solid rgba(34,197,94,.25); }

  .priority-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .p-high    { background: var(--red); }
  .p-medium  { background: var(--yellow); }
  .p-low     { background: var(--green); }

  /* â”€â”€ CALENDAR â”€â”€ */
  .event-row {
    display: flex; align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    gap: 14px;
  }
  .event-row:last-child { border-bottom: none; }
  .event-time {
    font-size: 11px;
    color: var(--muted2);
    min-width: 90px;
    font-feature-settings: "tnum";
  }
  .event-bar {
    width: 3px;
    border-radius: 2px;
    align-self: stretch;
    min-height: 20px;
    flex-shrink: 0;
  }
  .event-info { flex: 1; }
  .event-title { font-size: 12px; color: var(--text); }
  .event-meta  { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .event-duration {
    font-size: 11px;
    color: var(--muted);
    background: var(--bg3);
    padding: 2px 8px;
    border-radius: 10px;
  }

  /* â”€â”€ EMAILS â”€â”€ */
  .email-row {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background .12s;
    display: flex; gap: 12px; align-items: flex-start;
  }
  .email-row:last-child { border-bottom: none; }
  .email-row:hover { background: var(--bg3); }
  .email-avatar {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .email-body { flex: 1; min-width: 0; }
  .email-from    { font-size: 11px; color: var(--text); font-weight: 500; }
  .email-subject { font-size: 11px; color: var(--muted2); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-time    { font-size: 10px; color: var(--muted); }
  .email-star { color: var(--yellow); font-size: 12px; }

  /* â”€â”€ TASKS â”€â”€ */
  .task-row {
    display: flex; align-items: center;
    padding: 11px 20px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
  }
  .task-row:last-child { border-bottom: none; }
  .task-check {
    width: 16px; height: 16px;
    border-radius: 4px;
    border: 1.5px solid var(--border2);
    flex-shrink: 0;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .task-check.done { background: var(--green); border-color: var(--green); }
  .task-check.done::after { content: 'âœ“'; color: #fff; font-size: 9px; }
  .task-text { flex: 1; font-size: 12px; color: var(--text); }
  .task-text.done { text-decoration: line-through; color: var(--muted); }
  .task-due { font-size: 10px; color: var(--muted); }
  .task-due.overdue { color: var(--red); }

  /* â”€â”€ CHART â”€â”€ */
  .chart-wrap { padding: 20px; }
  .mini-bar-chart { display: flex; align-items: flex-end; gap: 6px; height: 80px; }
  .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    transition: height .4s cubic-bezier(.4,0,.2,1), opacity .2s;
    cursor: pointer;
    min-height: 4px;
  }
  .bar:hover { opacity: .8; }
  .bar-label { font-size: 9px; color: var(--muted); letter-spacing: .3px; }

  /* Donut */
  .donut-wrap { display: flex; align-items: center; gap: 20px; padding: 20px; }
  svg.donut { flex-shrink: 0; }
  .donut-legend { display: flex; flex-direction: column; gap: 8px; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-count { color: var(--muted2); margin-left: auto; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { display: flex; border-bottom: 1px solid var(--border); }
  .tab {
    padding: 10px 20px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
    letter-spacing: .3px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent2); border-bottom-color: var(--accent); }

  /* â”€â”€ EMPTY â”€â”€ */
  .empty { padding: 32px 20px; text-align: center; color: var(--muted); font-size: 12px; }

  /* â”€â”€ SCROLLBAR â”€â”€ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* â”€â”€ FADE IN â”€â”€ */
  .fade-in { animation: fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

  /* â”€â”€ SETTINGS PANEL â”€â”€ */
  .settings-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.6);
    z-index: 200;
    backdrop-filter: blur(4px);
  }
  .settings-overlay.open { display: flex; align-items: center; justify-content: center; }
  .settings-modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 14px;
    width: 420px;
    padding: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  .settings-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 20px; }
  .field-group { margin-bottom: 16px; }
  .field-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .field-input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    outline: none;
    transition: border-color .15s;
  }
  .field-input:focus { border-color: var(--accent); }
  .field-input::placeholder { color: var(--muted); }
  .modal-actions { display: flex; gap: 10px; margin-top: 24px; justify-content: flex-end; }
  .btn-primary {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 9px 20px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: background .15s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary {
    background: transparent;
    color: var(--muted2);
    border: 1px solid var(--border2);
    padding: 9px 20px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: all .15s;
  }
  .btn-secondary:hover { color: var(--text); border-color: var(--border); }

  /* â”€â”€ NOTIFICATION â”€â”€ */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 12px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(0,0,0,.4);
    transform: translateY(60px);
    opacity: 0;
    transition: all .3s cubic-bezier(.4,0,.2,1);
    z-index: 300;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show { transform: none; opacity: 1; }

  /* â”€â”€ NAV BADGE â”€â”€ */
  .nav-badge {
    margin-left: auto;
    background: var(--accent);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    min-width: 16px;
    height: 16px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    line-height: 1;
  }
  .nav-badge.red { background: var(--red); }

  /* â”€â”€ MEETING ALERT â”€â”€ */
  .meeting-alert {
    position: fixed;
    top: 20px; right: 20px;
    background: var(--bg3);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 14px 18px;
    font-size: 12px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(59,130,246,.25);
    z-index: 400;
    display: flex; align-items: center; gap: 12px;
    max-width: 300px;
    transform: translateX(340px);
    opacity: 0;
    transition: all .4s cubic-bezier(.4,0,.2,1);
  }
  .meeting-alert.show { transform: none; opacity: 1; }
  .meeting-alert-icon { font-size: 20px; flex-shrink: 0; }
  .meeting-alert-title { font-weight: 600; color: var(--accent2); font-size: 11px; }
  .meeting-alert-sub { font-size: 10px; color: var(--muted2); margin-top: 2px; }
  .meeting-alert-close {
    position: absolute; top: 8px; right: 10px;
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 14px; line-height: 1;
  }

  /* â”€â”€ SKELETON â”€â”€ */
  .skeleton {
    background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
    border-radius: 4px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .skeleton-row { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
  .skeleton-avatar { width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0; }
  .skeleton-line { height: 10px; border-radius: 4px; }
  .skeleton-body { flex: 1; display: flex; flex-direction: column; gap: 6px; }

  /* â”€â”€ THEME TOGGLE â”€â”€ */
  .theme-btn {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--muted2);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .theme-btn:hover { border-color: var(--accent); color: var(--accent2); }

  /* â”€â”€ AUTO-REFRESH INDICATOR â”€â”€ */
  .auto-refresh-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    display: inline-block;
    margin-left: 4px;
    animation: pulse 2s infinite;
  }

  /* â”€â”€ GOOGLE AUTH â”€â”€ */
  .google-btn {
    width: 100%;
    background: #fff;
    border: 1px solid #dadce0;
    color: #3c4043;
    padding: 8px 12px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: .3px;
    transition: all .2s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }
  .google-btn:hover { background: #f8f9fa; box-shadow: 0 1px 6px rgba(0,0,0,.2); }
  .google-btn svg { flex-shrink: 0; }

  .user-info {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 8px;
  }
  .user-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px;
    color: #fff; overflow: hidden; flex-shrink: 0;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-name { font-size: 11px; color: var(--muted2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .logout-btn {
    background: transparent; border: none; color: var(--muted); font-size: 10px;
    cursor: pointer; padding: 0; text-decoration: underline; font-family: inherit;
  }
  .logout-btn:hover { color: var(--red); }

  /* â”€â”€ LOADING SPINNER â”€â”€ */
  .loading-row {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 24px 20px; color: var(--muted); font-size: 12px;
  }
  @keyframes spin2 { to { transform: rotate(360deg); } }
  .spin { animation: spin2 .8s linear infinite; display: inline-block; }

  @media (max-width: 900px) {
    .sidebar { width: 60px; }
    .sidebar .logo-mark, .sidebar .logo-sub, .sidebar .nav-item span, .sidebar-footer { display: none; }
    .nav-item { justify-content: center; padding: 14px; }
    .main { margin-left: 60px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .content { padding: 20px 16px; }
    .topbar { padding: 14px 16px; }
  }
</style>
</head>
<body>

<div class="app">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark">daily<span>.</span>report</div>
      <div class="logo-sub">workspace hub</div>
    </div>

    <nav>
      <div class="nav-item active" onclick="setView('dashboard')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1" y="1" width="6" height="6" rx="1.5"/>
          <rect x="9" y="1" width="6" height="6" rx="1.5"/>
          <rect x="1" y="9" width="6" height="6" rx="1.5"/>
          <rect x="9" y="9" width="6" height="6" rx="1.5"/>
        </svg>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="setView('jira')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="6.5"/>
          <path d="M8 5v3.5l2 2"/>
        </svg>
        <span>Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</span>
        <span class="nav-badge" id="jiraBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('calendar')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1.5" y="2.5" width="13" height="12" rx="2"/>
          <path d="M1.5 6.5h13M5 1v3M11 1v3"/>
        </svg>
        <span>ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</span>
        <span class="nav-badge" id="calBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('email')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1" y="3" width="14" height="10" rx="2"/>
          <path d="M1 5l7 5 7-5"/>
        </svg>
        <span>Gmail</span>
        <span class="nav-badge red" id="gmailBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('tasks')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M2 4h12M2 8h8M2 12h5"/>
          <circle cx="13" cy="11" r="2.5"/>
          <path d="M13 9.5v1.5l1 1"/>
        </svg>
        <span>Tasks</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      <!-- User block (shown when authenticated) -->
      <div id="userBlock" style="display:none">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="user-name" id="userName"></div>
        </div>
        <button class="sync-btn" id="syncBtn" onclick="syncData()">
          <svg class="sync-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M10 6A4 4 0 1 1 6 2M6 2l2-2M6 2l2 2"/>
          </svg>
          <span>Sync</span>
        </button>
        <div class="last-sync" id="lastSync">Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾</div>
        <button class="sync-btn" onclick="sendTelegramReport()" id="tgBtn" style="margin-top:8px;background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.25);color:var(--green)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12L7.88 13.67l-2.967-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.953l-.524-.064z"/>
          </svg>
          <span>ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ² Telegram</span>
        </button>
        <button class="logout-btn" onclick="logout()" style="margin-top:8px;width:100%;text-align:center">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
      </div>

      <!-- Login block (shown when not authenticated) -->
      <div id="loginBlock">
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:.5px">ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ˜Ğ¢Ğ¬ GMAIL</div>
        <a href="/api/auth/google" class="google-btn">
          <svg width="14" height="14" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google
        </a>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN â”€â”€ -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="page-date" id="pageDate"></div>
      </div>
      <div class="topbar-right">
        <div class="date-nav">
          <button onclick="changeDate(-1)">â€¹</button>
          <div class="date-label" id="dateLabel"></div>
          <button onclick="changeDate(1)">â€º</button>
        </div>
        <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞ¼Ñƒ">ğŸŒ™</button>
        <div class="badge"><div class="badge-dot"></div>LIVE</div>
        <button class="btn-secondary" onclick="openSettings()" style="font-size:11px;padding:6px 14px;">âš™ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
      </div>
    </div>

    <div class="content" id="mainContent"></div>
  </main>
</div>

<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-modal">
    <div class="settings-title">âš™ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ</div>

    <div class="field-group">
      <div class="field-label">Jira Domain</div>
      <input class="field-input" id="cfgJiraDomain" placeholder="your-company.atlassian.net">
    </div>
    <div class="field-group">
      <div class="field-label">Jira Email</div>
      <input class="field-input" id="cfgJiraEmail" type="email" placeholder="your@email.com">
    </div>
    <div class="field-group">
      <div class="field-label">Jira API Token</div>
      <input class="field-input" id="cfgJiraToken" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div class="field-group">
      <div class="field-label">Telegram Bot Token</div>
      <input class="field-input" id="cfgTgToken" type="password" placeholder="123456789:ABC...">
    </div>
    <div class="field-group">
      <div class="field-label">Telegram Chat ID</div>
      <input class="field-input" id="cfgTgChatId" placeholder="-100xxxxxxxxxx">
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn-primary" onclick="saveSettings()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Meeting Alert -->
<div class="meeting-alert" id="meetingAlert">
  <div class="meeting-alert-icon">ğŸ“…</div>
  <div>
    <div class="meeting-alert-title" id="meetingAlertTitle"></div>
    <div class="meeting-alert-sub" id="meetingAlertSub"></div>
  </div>
  <button class="meeting-alert-close" onclick="closeMeetingAlert()">âœ•</button>
</div>

<script>
// ============================================================
//  DATA (demo â€” Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ API Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹)
// ============================================================
const DATA = {
  jira: [
    { key:'PROJ-142', summary:'Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ OAuth 2.0 Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ¾Ğ¼', status:'In Progress', priority:'High',    project:'Backend API',  updated:'10 Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´' },
    { key:'PROJ-138', summary:'Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ÑĞµÑ€Ğ²Ğ¸ÑĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹',            status:'In Progress', priority:'Medium',  project:'Backend API',  updated:'2 Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´'    },
    { key:'PROJ-151', summary:'Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½-Ñ€ĞµĞ²ÑŒÑ ÑĞºÑ€Ğ°Ğ½Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº',               status:'Review',      priority:'Medium',  project:'Mobile App',   updated:'3 Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´'    },
    { key:'PROJ-129', summary:'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ unit-Ñ‚ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹',      status:'Review',      priority:'High',    project:'Backend API',  updated:'Ğ²Ñ‡ĞµÑ€Ğ°'        },
    { key:'PROJ-155', summary:'ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ·Ğ° Q4',                        status:'To Do',       priority:'Low',     project:'Analytics',    updated:'Ğ²Ñ‡ĞµÑ€Ğ°'        },
    { key:'PROJ-147', summary:'ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ API v3',               status:'To Do',       priority:'Low',     project:'Backend API',  updated:'2 Ğ´Ğ½Ñ Ğ½Ğ°Ğ·Ğ°Ğ´'  },
    { key:'PROJ-160', summary:'Ğ‘Ğ°Ğ³: Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ´Ğ°Ñ‚ Ğ² Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°Ñ…',     status:'To Do',       priority:'High',    project:'Analytics',    updated:'1 Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´'    },
    { key:'PROJ-135', summary:'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ CI/CD pipeline Ğ´Ğ»Ñ staging',       status:'Done',        priority:'Medium',  project:'DevOps',       updated:'ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ'      }
  ],
  events: [
    { title:'Daily Standup',         start:'09:00', end:'09:30', color:'#3b82f6', attendees:6,  type:'recurring'  },
    { title:'Jira Sprint Review',    start:'11:00', end:'12:00', color:'#a855f7', attendees:12, type:'team'       },
    { title:'1:1 Ñ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ĞµĞ¼',   start:'14:00', end:'14:30', color:'#06b6d4', attendees:2,  type:'personal'   },
    { title:'ĞšĞ¾Ğ´-Ñ€ĞµĞ²ÑŒÑ ÑĞµÑÑĞ¸Ñ',      start:'15:30', end:'16:30', color:'#22c55e', attendees:4,  type:'technical'  },
    { title:'Retrospective Q4',      start:'17:00', end:'18:00', color:'#f97316', attendees:8,  type:'planning'   }
  ],
  emails: [
    { from:'ĞĞ»ĞµĞºÑĞµĞ¹ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²',   addr:'a.ivanov@corp.com',   subject:'Re: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´ĞµĞ´Ğ»Ğ°Ğ¹Ğ½Ğ° PROJ-142',          time:'10:24', starred:true,  color:'#3b82f6', init:'ĞĞ˜' },
    { from:'ĞœĞ°Ñ€Ğ¸Ñ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ°',    addr:'m.petrova@corp.com',  subject:'ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ: Sprint Planning Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ° 11:00', time:'09:47', starred:true,  color:'#a855f7', init:'ĞœĞŸ' },
    { from:'Jira',             addr:'noreply@atlassian.com',subject:'PROJ-155 Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¾ Ğ½Ğ° Ğ²Ğ°Ñ',                 time:'09:15', starred:false, color:'#1c2330', init:'J'  },
    { from:'DevOps Bot',       addr:'devops@corp.com',     subject:'âœ… Deployment to staging ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾',           time:'08:53', starred:false, color:'#22c55e', init:'D'  },
    { from:'Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹ Ğ¡Ğ¾ĞºĞ¾Ğ»Ğ¾Ğ²', addr:'d.sokolov@corp.com',  subject:'Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ°',             time:'Ğ²Ñ‡ĞµÑ€Ğ°', starred:false, color:'#f97316', init:'Ğ”Ğ¡' }
  ],
  tasks: [
    { text:'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ OAuth Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ',          due:'ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ',   done:false, overdue:false },
    { text:'ĞŸÑ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ ĞºĞ¾Ğ´-Ñ€ĞµĞ²ÑŒÑ PR #847',           due:'ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ',   done:false, overdue:false },
    { text:'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ payment service',  due:'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°',    done:false, overdue:false },
    { text:'ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Confluence ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ',        due:'Ğ¿Ñ‚, 19 Ñ„ĞµĞ²',done:false, overdue:false },
    { text:'Ğ¡Ğ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒÑÑ Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ Ğ¼Ğ¾Ğ±Ğ°Ğ¹Ğ»',       due:'Ğ²Ñ‡ĞµÑ€Ğ°',     done:false, overdue:true  },
    { text:'Review Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½-Ğ¼Ğ°ĞºĞµÑ‚Ğ° v2',             due:'ÑÑ€ĞµĞ´Ğ°',     done:true,  overdue:false },
    { text:'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ',         due:'Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°',   done:true,  overdue:false }
  ],
  weekActivity: [12,8,15,6,18,10,14]
};

// ============================================================
//  STATE
// ============================================================
let currentView = 'dashboard';
let currentDate = new Date();
let taskState   = DATA.tasks.map(t => t.done);

// ============================================================
//  UTILS
// ============================================================
function fmt(d) {
  const days  = ['Ğ’Ñ','ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±'];
  const months= ['ÑĞ½Ğ²','Ñ„ĞµĞ²','Ğ¼Ğ°Ñ€','Ğ°Ğ¿Ñ€','Ğ¼Ğ°Ğ¹','Ğ¸ÑĞ½','Ğ¸ÑĞ»','Ğ°Ğ²Ğ³','ÑĞµĞ½','Ğ¾ĞºÑ‚','Ğ½Ğ¾Ñ','Ğ´ĞµĞº'];
  return days[d.getDay()] + ', ' + d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
}
function fmtShort(d) {
  const months=['ÑĞ½Ğ²','Ñ„ĞµĞ²','Ğ¼Ğ°Ñ€','Ğ°Ğ¿Ñ€','Ğ¼Ğ°Ğ¹','Ğ¸ÑĞ½','Ğ¸ÑĞ»','Ğ°Ğ²Ğ³','ÑĞµĞ½','Ğ¾ĞºÑ‚','Ğ½Ğ¾Ñ','Ğ´ĞµĞº'];
  return d.getDate() + ' ' + months[d.getMonth()];
}
function duration(start, end) {
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  const mins=(eh*60+em)-(sh*60+sm);
  return mins>=60 ? Math.floor(mins/60)+'Ñ‡ '+(mins%60?mins%60+'Ğ¼':'') : mins+'Ğ¼';
}
function statusClass(s) {
  const sl = s.toLowerCase();
  if(sl.includes('progress')||sl.includes('dev')||sl.includes('Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚')) return 'status-progress';
  if(sl.includes('review')||sl.includes('test')||sl.includes('approval')||sl.includes('approving')) return 'status-review';
  if(sl==='to do'||sl==='open'||sl==='backlog'||sl.includes('Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ')||sl.includes('not doing')||sl.includes('Ğ¾Ñ‚Ğ¼ĞµĞ½')) return 'status-todo';
  if(sl==='done'||sl==='closed'||sl==='Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'||sl.includes('complete')||sl.includes('resolved')) return 'status-done';
  return 'status-todo';
}
function priorityClass(p) {
  if(p==='High'||p==='Highest') return 'p-high';
  if(p==='Low'||p==='Lowest')   return 'p-low';
  return 'p-medium';
}
function statusLabel(s) {
  const m={
    'In Progress':'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ','Review':'ĞĞ° Ñ€ĞµĞ²ÑŒÑ','To Do':'Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ','Done':'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
    'Open':'ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ°','Backlog':'Ğ‘ÑĞºĞ»Ğ¾Ğ³','Testing':'Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ',
    'Needs Approval':'ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ°Ğ¿Ñ€ÑƒĞ²','Not Doing':'ĞĞµ Ğ´ĞµĞ»Ğ°ĞµĞ¼','Closed':'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°',
    'In Review':'ĞĞ° Ñ€ĞµĞ²ÑŒÑ','Resolved':'Ğ ĞµÑˆĞµĞ½Ğ¾'
  };
  return m[s] || s;
}

// Groups for tab filtering â€” maps tab index to status matcher function
function jiraStatusGroup(status) {
  const sl = status.toLowerCase();
  if(sl.includes('progress')||sl.includes('dev')||sl.includes('Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚')) return 'inprogress';
  if(sl.includes('review')||sl.includes('test')||sl.includes('approval')||sl.includes('approving')) return 'review';
  if(sl==='done'||sl==='closed'||sl==='Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'||sl.includes('complete')||sl.includes('resolved')) return 'done';
  return 'todo'; // To Do, Not Doing, Open, Backlog etc
}

// ============================================================
//  RENDER
// ============================================================
function render() {
  const el = document.getElementById('mainContent');
  el.className = 'content fade-in';
  void el.offsetWidth;

  const titles = {dashboard:'Dashboard', jira:'Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸', calendar:'ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ', email:'Gmail', tasks:'Google Tasks'};
  document.getElementById('pageTitle').textContent = titles[currentView];
  document.getElementById('pageDate').textContent  = fmt(currentDate);
  document.getElementById('dateLabel').textContent = fmtShort(currentDate);

  switch(currentView) {
    case 'dashboard': el.innerHTML = renderDashboard(); break;
    case 'jira':      el.innerHTML = (window.renderJiraFull  || renderJiraFull)();  break;
    case 'calendar':  el.innerHTML = (window.renderCalFull   || renderCalFull)();   break;
    case 'email':     el.innerHTML = (window.renderEmailFull || renderEmailFull)(); break;
    case 'tasks':     el.innerHTML = (window.renderTasksFull || renderTasksFull)(); break;
  }

  // sidebar active
  document.querySelectorAll('.nav-item').forEach((n,i)=>{
    n.classList.remove('active');
    if(['dashboard','jira','calendar','email','tasks'][i]===currentView) n.classList.add('active');
  });

  // bind task toggles
  document.querySelectorAll('.task-check').forEach((el,i)=>{
    el.addEventListener('click', ()=>{ taskState[i]=!taskState[i]; render(); });
  });
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const inProgress = DATA.jira.filter(j=>j.status==='In Progress').length;
  const onReview   = DATA.jira.filter(j=>j.status==='Review').length;
  const totalMin   = DATA.events.reduce((s,e)=>{
    const[sh,sm]=e.start.split(':').map(Number),[eh,em]=e.end.split(':').map(Number);
    return s+(eh*60+em)-(sh*60+sm);
  },0);
  const pendingTasks = taskState.filter(t=>!t).length;

  return `
  <div class="stats-row">
    <div class="stat-card blue">
      <div class="stat-label">Jira Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</div>
      <div class="stat-value blue">${jiraIssues ? jiraIssues.filter(j=>j.status.toLowerCase().includes('progress')||j.status.toLowerCase().includes('dev')).length : inProgress}</div>
      <div class="stat-sub">+${jiraIssues ? jiraIssues.filter(j=>j.status.toLowerCase().includes('review')||j.status.toLowerCase().includes('test')).length : onReview} Ğ½Ğ° Ñ€ĞµĞ²ÑŒÑ</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
      <div class="stat-value green">${calEvents ? calEvents.length : DATA.events.length}</div>
      <div class="stat-sub">${calEvents ? calEvents.filter(e=>e.meetLink).length+' Ñ Meet-ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹' : Math.floor(totalMin/60)+'Ñ‡ '+totalMin%60+'Ğ¼ Ğ²ÑĞµĞ³Ğ¾'}</div>
    </div>
    <div class="stat-card yellow">
      <div class="stat-label">ĞĞ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¸ÑĞµĞ¼</div>
      <div class="stat-value yellow">${gmailMessages ? gmailMessages.length : DATA.emails.length}</div>
      <div class="stat-sub">${gmailMessages ? gmailMessages.filter(m=>m.unread).length+' Ğ½ĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ…' : DATA.emails.filter(e=>e.starred).length+' Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°'}</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-label">Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸</div>
      <div class="stat-value purple">${realTasks ? realTasks.filter(t=>!t.done).length : pendingTasks}</div>
      <div class="stat-sub">${realTasks ? realTasks.filter(t=>t.overdue&&!t.done).length+' Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾' : taskState.filter(Boolean).length+' Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾'}</div>
    </div>
  </div>

  <div class="grid-3">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</div>
        <div class="card-count">${jiraIssues ? jiraIssues.filter(j=>j.status!=='Done'&&j.status!=='Closed').length : DATA.jira.filter(j=>j.status!=='Done').length}</div>
      </div>
      <div class="card-body">
        ${jiraIssues === null
          ? '<div class="loading-row"><span class="spin">âŸ³</span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼...</div>'
          : jiraIssues.length === 0 && jiraCfgSet()
            ? '<div class="empty">Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚</div>'
            : !jiraCfgSet()
              ? '<div class="empty" style="padding:20px">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Jira Ğ² <span style="color:var(--accent2);cursor:pointer" onclick="openSettings()">Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… âš™</span></div>'
              : jiraIssues.filter(j=>j.status!=='Done'&&j.status!=='Closed').slice(0,5).map(renderIssueRow).join('')
        }
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹</div>
      </div>
      ${renderDonut()}
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--green)"></div>Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
        <div class="card-count">${DATA.events.length}</div>
      </div>
      <div class="card-body">${DATA.events.map(renderEventRow).join('')}</div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</div>
      </div>
      ${renderBarChart()}
    </div>
  </div>`;
}

// â”€â”€ JIRA FULL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJiraFull() {
  const statuses = ['In Progress','Review','To Do','Done'];
  const labels   = {  'In Progress':'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ','Review':'ĞĞ° Ñ€ĞµĞ²ÑŒÑ','To Do':'Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ','Done':'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'};
  const colors   = {  'In Progress':var_accent,'Review':var_purple,'To Do':var_muted,'Done':var_green};

  return `
  <div class="tabs">
    ${['Ğ’ÑĞµ','Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ','ĞĞ° Ñ€ĞµĞ²ÑŒÑ','Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ','Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'].map((t,i)=>`
      <div class="tab${i===0?' active':''}" onclick="filterJira(${i},this)">${t}</div>`).join('')}
  </div>
  <div class="card" style="margin-top:16px" id="jiraList">
    ${DATA.jira.map(renderIssueRowFull).join('')}
  </div>`;
}

// â”€â”€ CAL FULL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--green)"></div>Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ½Ñ</div>
      <div class="card-count">${DATA.events.length} Ğ²ÑÑ‚Ñ€ĞµÑ‡</div>
    </div>
    <div class="card-body">${DATA.events.map(renderEventRowFull).join('')}</div>
  </div>`;
}

// â”€â”€ EMAIL FULL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEmailFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°</div>
      <div class="card-count">${DATA.emails.length}</div>
    </div>
    <div class="card-body">${DATA.emails.map(renderEmailRow).join('')}</div>
  </div>`;
}

// â”€â”€ TASKS FULL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasksFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      <div class="card-count">${taskState.filter(Boolean).length}/${taskState.length} Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾</div>
    </div>
    <div class="card-body">${DATA.tasks.map((t,i)=>renderTaskRow(t,i)).join('')}</div>
  </div>`;
}

// â”€â”€ COMPONENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIssueRow(issue) {
  return `<div class="issue-row">
    <div class="priority-dot ${priorityClass(issue.priority)}"></div>
    <div class="issue-key">${issue.key}</div>
    <div style="flex:1;min-width:0">
      <div class="issue-summary" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${issue.summary}</div>
      <div class="issue-project">${issue.project}</div>
    </div>
    <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
  </div>`;
}

function renderIssueRowFull(issue) {
  return `<div class="issue-row" data-status="${issue.status}">
    <div class="priority-dot ${priorityClass(issue.priority)}"></div>
    <div class="issue-key">${issue.key}</div>
    <div style="flex:1;min-width:0">
      <div class="issue-summary">${issue.summary}</div>
      <div class="issue-project">${issue.project} Â· ${issue.updated}</div>
    </div>
    <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    <span style="font-size:10px;color:var(--muted);margin-left:4px">${issue.priority}</span>
  </div>`;
}

function renderEventRow(e) {
  const dur = duration(e.start,e.end);
  return `<div class="event-row">
    <div class="event-time">${e.start} â€“ ${e.end}</div>
    <div class="event-bar" style="background:${e.color}"></div>
    <div class="event-info">
      <div class="event-title">${e.title}</div>
      <div class="event-meta">${e.attendees} ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²</div>
    </div>
    <div class="event-duration">${dur}</div>
  </div>`;
}

function renderEventRowFull(e) {
  const dur = duration(e.start,e.end);
  return `<div class="event-row">
    <div class="event-time">${e.start} â€“ ${e.end}</div>
    <div class="event-bar" style="background:${e.color}"></div>
    <div class="event-info">
      <div class="event-title">${e.title}</div>
      <div class="event-meta">${e.attendees} ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Â· ${e.type}</div>
    </div>
    <div class="event-duration">${dur}</div>
  </div>`;
}

function renderEmailRow(e) {
  return `<div class="email-row">
    <div class="email-avatar" style="background:${e.color}20;color:${e.color}">${e.init}</div>
    <div class="email-body">
      <div class="email-from">${e.from} <span style="color:var(--muted);font-weight:400">&lt;${e.addr}&gt;</span></div>
      <div class="email-subject">${e.subject}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
      <div class="email-time">${e.time}</div>
      ${e.starred ? '<div class="email-star">â˜…</div>' : ''}
    </div>
  </div>`;
}

function renderTaskRow(t,i) {
  const done = taskState[i];
  return `<div class="task-row">
    <div class="task-check ${done?'done':''}"></div>
    <div class="task-text ${done?'done':''}">${t.text}</div>
    <div class="task-due ${t.overdue&&!done?'overdue':''}">${t.due}</div>
  </div>`;
}

function renderDonut() {
  const groups = {
    'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ':   DATA.jira.filter(j=>j.status==='In Progress').length,
    'ĞĞ° Ñ€ĞµĞ²ÑŒÑ':   DATA.jira.filter(j=>j.status==='Review').length,
    'Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ':DATA.jira.filter(j=>j.status==='To Do').length,
    'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾':     DATA.jira.filter(j=>j.status==='Done').length
  };
  const colors = ['#3b82f6','#a855f7','#64748b','#22c55e'];
  const total  = Object.values(groups).reduce((a,b)=>a+b,0);

  let offset=0, paths='';
  const R=30,cx=40,cy=40,stroke=10;
  const circ=2*Math.PI*R;

  Object.values(groups).forEach((v,i)=>{
    const dash = (v/total)*circ;
    const rot  = offset*(360/total);
    paths += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${colors[i]}"
      stroke-width="${stroke}" stroke-dasharray="${dash} ${circ-dash}"
      stroke-dashoffset="${circ/4-offset/total*circ}"
      transform="rotate(${rot-90} ${cx} ${cy})" style="transition:all .5s"/>`;
    offset+=v;
  });

  const legend = Object.entries(groups).map(([label,count],i)=>`
    <div class="legend-item">
      <div class="legend-dot" style="background:${colors[i]}"></div>
      <span>${label}</span>
      <span class="legend-count">${count}</span>
    </div>`).join('');

  return `<div class="donut-wrap">
    <svg class="donut" width="80" height="80" viewBox="0 0 80 80">${paths}
      <text x="40" y="44" text-anchor="middle" fill="#e2e8f0" font-family="Syne,sans-serif" font-size="14" font-weight="700">${total}</text>
    </svg>
    <div class="donut-legend">${legend}</div>
  </div>`;
}

function renderBarChart() {
  const days = ['ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±','Ğ’Ñ'];
  const max  = Math.max(...DATA.weekActivity);
  const today= new Date().getDay();
  const bars = DATA.weekActivity.map((v,i)=>{
    const h    = Math.round((v/max)*70);
    const isT  = i===(today===0?6:today-1);
    const color= isT ? '#3b82f6' : '#1c2330';
    const bord = isT ? '1px solid rgba(59,130,246,.4)' : '1px solid var(--border)';
    return `<div class="bar-col">
      <div class="bar" style="height:${h}px;background:${color};border:${bord};" title="${v} Ğ·Ğ°Ğ´Ğ°Ñ‡"></div>
      <div class="bar-label">${days[i]}</div>
    </div>`;
  }).join('');
  return `<div class="chart-wrap"><div class="mini-bar-chart">${bars}</div></div>`;
}

// â”€â”€ CSS VARS for JS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const var_accent='#3b82f6',var_purple='#a855f7',var_green='#22c55e',var_muted='#64748b';

// ============================================================
//  ACTIONS
// ============================================================
function setView(v) {
  currentView = v;
  render();
}

function changeDate(d) {
  currentDate = new Date(currentDate);
  currentDate.setDate(currentDate.getDate()+d);
  render();
}

function filterJira(idx, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  // idx: 0=Ğ²ÑĞµ, 1=Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ, 2=Ñ€ĞµĞ²ÑŒÑ/Ñ‚ĞµÑÑ‚, 3=Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ, 4=Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾
  const groupMap = [null,'inprogress','review','todo','done'];
  const filter   = groupMap[idx];
  document.querySelectorAll('#jiraList .issue-row').forEach(row=>{
    const group = jiraStatusGroup(row.dataset.status || '');
    row.style.display = (!filter || group === filter) ? '' : 'none';
  });
}

async function syncData() {
  const btn  = document.getElementById('syncBtn');
  const sync = document.getElementById('lastSync');
  btn.classList.add('syncing');
  showToast('âŸ³ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...');

  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  jiraIssues    = null;
  render();

  await Promise.all([
    loadGmailMessages(),
    loadCalendarEvents(),
    loadTasks(),
    loadJiraIssues()
  ]);

  btn.classList.remove('syncing');
  const now = new Date();
  sync.textContent = 'Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  showToast('âœ“ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹');
}

function openSettings() {
  const cfg = JSON.parse(localStorage.getItem('drCfg')||'{}');
  document.getElementById('cfgJiraDomain').value = cfg.jiraDomain||'';
  document.getElementById('cfgJiraEmail').value  = cfg.jiraEmail||'';
  document.getElementById('cfgJiraToken').value  = cfg.jiraToken||'';
  document.getElementById('cfgTgToken').value    = cfg.tgToken||'';
  document.getElementById('cfgTgChatId').value   = cfg.tgChatId||'';
  document.getElementById('settingsOverlay').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
}
function saveSettings() {
  const cfg = {
    jiraDomain: document.getElementById('cfgJiraDomain').value.trim(),
    jiraEmail:  document.getElementById('cfgJiraEmail').value.trim(),
    jiraToken:  document.getElementById('cfgJiraToken').value.trim(),
    tgToken:    document.getElementById('cfgTgToken').value.trim(),
    tgChatId:   document.getElementById('cfgTgChatId').value.trim()
  };
  localStorage.setItem('drCfg', JSON.stringify(cfg));
  closeSettings();
  showToast('âœ“ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹');
  // Reload Jira with new credentials
  loadJiraIssues();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2500);
}

// ============================================================
//  AUTH & REAL DATA
// ============================================================
let currentUser    = null;
let gmailMessages  = null; // null = loading, [] = empty
let calEvents      = null;
let realTasks      = null;
let jiraIssues     = null; // null = loading, [] = empty

async function checkAuth() {
  try {
    const res  = await fetch('/api/auth/me');
    const data = await res.json();
    if (data.authenticated) {
      currentUser = data;
      showUserBlock(data);
      // Load all Google data in parallel
      loadGmailMessages();
      loadCalendarEvents();
      loadTasks();
    } else {
      showLoginBlock();
    }
  } catch {
    showLoginBlock();
  }
  // Jira uses its own credentials â€” load independently of Google auth
  loadJiraIssues();
}

async function loadJiraIssues() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  if (!cfg.jiraDomain || !cfg.jiraEmail || !cfg.jiraToken) {
    jiraIssues = []; // no credentials â€” show setup prompt
    render();
    return;
  }
  jiraIssues = null; // loading
  render();
  try {
    const res  = await fetch('/api/jira/issues', {
      headers: {
        'x-jira-domain': cfg.jiraDomain,
        'x-jira-email':  cfg.jiraEmail,
        'x-jira-token':  cfg.jiraToken
      }
    });
    const data = await res.json();
    if (data.issues) {
      jiraIssues = data.issues;
    } else {
      jiraIssues = [];
      console.error('Jira error:', data.error);
    }
    render();
  } catch (err) {
    console.error('Failed to load Jira:', err);
    jiraIssues = [];
    render();
  }
}

async function loadCalendarEvents() {
  try {
    const res  = await fetch('/api/calendar/events');
    const data = await res.json();
    if (data.events) {
      calEvents = data.events;
      render();
    }
  } catch (err) {
    console.error('Failed to load Calendar:', err);
  }
}

async function loadTasks() {
  try {
    const res  = await fetch('/api/tasks/list');
    const data = await res.json();
    if (data.tasks) {
      realTasks  = data.tasks;
      taskState  = data.tasks.map(t => t.done);
      render();
    }
  } catch (err) {
    console.error('Failed to load Tasks:', err);
  }
}

function showUserBlock(user) {
  document.getElementById('loginBlock').style.display = 'none';
  document.getElementById('userBlock').style.display  = 'block';
  document.getElementById('userName').textContent = user.name || user.email;
  const avatar = document.getElementById('userAvatar');
  if (user.picture) {
    avatar.innerHTML = `<img src="${user.picture}" alt="">`;
  } else {
    avatar.textContent = (user.name || user.email || '?')[0].toUpperCase();
  }
}

function showLoginBlock() {
  document.getElementById('loginBlock').style.display = 'block';
  document.getElementById('userBlock').style.display  = 'none';
}

async function loadGmailMessages() {
  try {
    const res  = await fetch('/api/gmail/messages');
    const data = await res.json();
    if (data.messages) {
      gmailMessages = data.messages;
      render();
    }
  } catch (err) {
    console.error('Failed to load Gmail:', err);
  }
}

function logout() {
  document.cookie = 'gauth=; Max-Age=0; Path=/';
  currentUser   = null;
  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  showLoginBlock();
  render();
}

function jiraCfgSet() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  return !!(cfg.jiraDomain && cfg.jiraEmail && cfg.jiraToken);
}

// â”€â”€ OVERRIDE renderEmailFull to use real data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _renderEmailFull = renderEmailFull;
window.renderEmailFull = function() {
  if (!currentUser) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="empty" style="padding:40px 20px">
        <div style="margin-bottom:12px;font-size:24px">ğŸ“¬</div>
        <div style="margin-bottom:16px">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Gmail Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¿Ğ¸ÑĞµĞ¼</div>
        <a href="/api/auth/google" class="google-btn" style="display:inline-flex;width:auto;padding:10px 20px">
          <svg width="14" height="14" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google
        </a>
      </div>
    </div>`;
  }

  if (gmailMessages === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="loading-row"><span class="spin">âŸ³</span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°...</div>
    </div>`;
  }

  if (gmailMessages.length === 0) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="empty">Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ¿ÑƒÑÑ‚Ñ‹</div>
    </div>`;
  }

  const rows = gmailMessages.map(m => {
    const initials = (m.from || '?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const colors   = ['#3b82f6','#a855f7','#22c55e','#f97316','#06b6d4','#ef4444'];
    const color    = colors[m.from.charCodeAt(0) % colors.length];
    const timeStr  = m.date ? new Date(m.date).toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="email-row">
      <div class="email-avatar" style="background:${color}20;color:${color}">${initials}</div>
      <div class="email-body">
        <div class="email-from" style="${m.unread?'font-weight:600':''}">${m.from}
          <span style="color:var(--muted);font-weight:400">&lt;${m.email}&gt;</span>
        </div>
        <div class="email-subject" style="${m.unread?'color:var(--text)':''}">${m.subject}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.snippet}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="email-time">${timeStr}</div>
        ${m.starred ? '<div class="email-star">â˜…</div>' : ''}
        ${m.unread  ? '<div style="width:7px;height:7px;border-radius:50%;background:var(--accent)"></div>' : ''}
      </div>
    </div>`;
  }).join('');

  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail â€” Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ</div>
      <div class="card-count">${gmailMessages.length}</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

// â”€â”€ OVERRIDE renderCalFull â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderCalFull = function() {
  if (!currentUser) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</div></div>
      <div class="empty" style="padding:32px 20px">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Google Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ</div></div>`;
  }
  if (calEvents === null) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</div></div>
      <div class="loading-row"><span class="spin">âŸ³</span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ...</div></div>`;
  }
  if (calEvents.length === 0) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</div></div>
      <div class="empty">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²ÑÑ‚Ñ€ĞµÑ‡ Ğ½ĞµÑ‚ ğŸ‰</div></div>`;
  }
  const rows = calEvents.map(e => {
    const timeStr = e.allDay ? 'Ğ’ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ' : `${e.start} â€“ ${e.end}`;
    const dur = (!e.allDay && e.start && e.end) ? calcDur(e.start, e.end) : '';
    const meetBtn = e.meetLink
      ? `<a href="${e.meetLink}" target="_blank" style="font-size:10px;color:var(--accent2);text-decoration:none;background:rgba(59,130,246,.1);padding:2px 8px;border-radius:10px;border:1px solid rgba(59,130,246,.2)">â–¶ Meet</a>`
      : '';
    return `<div class="event-row">
      <div class="event-time">${timeStr}</div>
      <div class="event-bar" style="background:${e.color}"></div>
      <div class="event-info">
        <div class="event-title">${e.title}</div>
        <div class="event-meta">${e.attendees} ÑƒÑ‡Ğ°ÑÑ‚Ğ½.${e.location ? ' Â· ' + e.location : ''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        ${meetBtn}
        ${dur ? `<div class="event-duration">${dur}</div>` : ''}
      </div>
    </div>`;
  }).join('');
  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--green)"></div>Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ½Ñ</div>
      <div class="card-count">${calEvents.length} Ğ²ÑÑ‚Ñ€ĞµÑ‡</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

function calcDur(start, end) {
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  const mins = (eh * 60 + em) - (sh * 60 + sm);
  if (mins <= 0) return '';
  return mins >= 60 ? Math.floor(mins/60) + 'Ñ‡' + (mins%60 ? ' ' + mins%60 + 'Ğ¼' : '') : mins + 'Ğ¼';
}

// â”€â”€ OVERRIDE renderTasksFull â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderTasksFull = function() {
  if (!currentUser) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="empty" style="padding:32px 20px">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Google Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</div></div>`;
  }
  if (realTasks === null) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="loading-row"><span class="spin">âŸ³</span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸...</div></div>`;
  }
  if (realTasks.length === 0) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="empty">Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚ ğŸ‰</div></div>`;
  }
  const done  = taskState.filter(Boolean).length;
  const rows  = realTasks.map((t, i) => {
    const isDone = taskState[i];
    return `<div class="task-row">
      <div class="task-check ${isDone ? 'done' : ''}"></div>
      <div style="flex:1;min-width:0">
        <div class="task-text ${isDone ? 'done' : ''}">${t.text}</div>
        ${t.list ? `<div style="font-size:10px;color:var(--muted)">${t.list}</div>` : ''}
      </div>
      <div class="task-due ${t.overdue && !isDone ? 'overdue' : ''}">${t.due}</div>
    </div>`;
  }).join('');
  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      <div class="card-count">${done}/${realTasks.length} Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

// â”€â”€ OVERRIDE renderJiraFull â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderJiraFull = function() {
  if (!jiraCfgSet()) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</div>
      </div>
      <div class="empty" style="padding:40px 20px">
        <div style="margin-bottom:12px;font-size:24px">ğŸ”§</div>
        <div style="margin-bottom:16px">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Jira credentials Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…</div>
        <button class="btn-primary" onclick="openSettings()" style="font-size:11px;padding:9px 20px">âš™ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
      </div>
    </div>`;
  }
  if (jiraIssues === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</div>
      </div>
      <div class="loading-row"><span class="spin">âŸ³</span> Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ· Jira...</div>
    </div>`;
  }
  if (jiraIssues.length === 0) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</div>
      </div>
      <div class="empty">ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚ ğŸ‰</div>
    </div>`;
  }

  const rows = jiraIssues.map(issue => `
    <div class="issue-row" data-status="${issue.status}" onclick="window.open('${issue.url}','_blank')" style="cursor:pointer">
      <div class="priority-dot ${priorityClass(issue.priority)}"></div>
      <div class="issue-key">${issue.key}</div>
      <div style="flex:1;min-width:0">
        <div class="issue-summary">${issue.summary}</div>
        <div class="issue-project">${issue.project} Â· ${issue.updated}</div>
      </div>
      <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    </div>`).join('');

  // Count per group for tab badges
  const counts = { all: jiraIssues.length, inprogress: 0, review: 0, todo: 0, done: 0 };
  jiraIssues.forEach(j => { counts[jiraStatusGroup(j.status)]++; });

  const tabs = [
    { label: 'Ğ’ÑĞµ',           count: counts.all,        group: null },
    { label: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',      count: counts.inprogress, group: 'inprogress' },
    { label: 'Ğ ĞµĞ²ÑŒÑ / Ğ¢ĞµÑÑ‚',  count: counts.review,     group: 'review' },
    { label: 'Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ',  count: counts.todo,        group: 'todo' },
    { label: 'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',        count: counts.done,        group: 'done' }
  ];

  return `
  <div class="tabs">
    ${tabs.map((t,i) => `
      <div class="tab${i===0?' active':''}" onclick="filterJira(${i},this)">
        ${t.label}${t.count > 0 ? ` <span style="font-size:9px;background:var(--bg4);padding:1px 5px;border-radius:8px;margin-left:3px">${t.count}</span>` : ''}
      </div>`).join('')}
  </div>
  <div class="card" style="margin-top:16px" id="jiraList">
    ${rows}
  </div>`;
};

// ============================================================
//  PHASE 1: AUTO-REFRESH + NAV BADGES + MEETING ALERTS
// ============================================================

// â”€â”€ 1. Auto-refresh every 5 minutes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AUTO_REFRESH_MS = 5 * 60 * 1000;
let autoRefreshTimer  = null;

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(async () => {
    // Silent refresh â€” don't show loading spinners, just update data
    const [gmailRes, calRes, tasksRes, jiraRes] = await Promise.allSettled([
      currentUser ? fetch('/api/gmail/messages').then(r=>r.json()) : Promise.resolve(null),
      currentUser ? fetch('/api/calendar/events').then(r=>r.json()) : Promise.resolve(null),
      currentUser ? fetch('/api/tasks/list').then(r=>r.json())     : Promise.resolve(null),
      jiraCfgSet() ? (() => {
        const cfg = JSON.parse(localStorage.getItem('drCfg')||'{}');
        return fetch('/api/jira/issues', {
          headers: { 'x-jira-domain': cfg.jiraDomain, 'x-jira-email': cfg.jiraEmail, 'x-jira-token': cfg.jiraToken }
        }).then(r=>r.json());
      })() : Promise.resolve(null)
    ]);

    if (gmailRes.value?.messages)  gmailMessages = gmailRes.value.messages;
    if (calRes.value?.events)      { calEvents = calRes.value.events; checkUpcomingMeetings(); }
    if (tasksRes.value?.tasks)     { realTasks = tasksRes.value.tasks; taskState = realTasks.map(t=>t.done); }
    if (jiraRes.value?.issues)     jiraIssues = jiraRes.value.issues;

    updateNavBadges();
    render();
    // Update last sync time quietly
    const now = new Date();
    const sync = document.getElementById('lastSync');
    if (sync) sync.textContent = 'Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  }, AUTO_REFRESH_MS);
}

// â”€â”€ 2. Nav Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNavBadges() {
  // Gmail â€” unread count
  const gmailBadge = document.getElementById('gmailBadge');
  if (gmailBadge && gmailMessages) {
    const unread = gmailMessages.filter(m=>m.unread).length;
    if (unread > 0) {
      gmailBadge.textContent = unread > 99 ? '99+' : unread;
      gmailBadge.style.display = 'inline-flex';
    } else {
      gmailBadge.style.display = 'none';
    }
  }

  // Jira â€” in-progress count
  const jiraBadge = document.getElementById('jiraBadge');
  if (jiraBadge && jiraIssues) {
    const active = jiraIssues.filter(j =>
      j.status.toLowerCase().includes('progress') ||
      j.status.toLowerCase().includes('review') ||
      j.status.toLowerCase().includes('dev')
    ).length;
    if (active > 0) {
      jiraBadge.textContent = active;
      jiraBadge.style.display = 'inline-flex';
    } else {
      jiraBadge.style.display = 'none';
    }
  }

  // Calendar â€” today's events count
  const calBadge = document.getElementById('calBadge');
  if (calBadge && calEvents) {
    const count = calEvents.length;
    if (count > 0) {
      calBadge.textContent = count;
      calBadge.style.display = 'inline-flex';
    } else {
      calBadge.style.display = 'none';
    }
  }
}

// â”€â”€ 3. Meeting Alerts (notify 10 min before) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const notifiedMeetings = new Set();

function checkUpcomingMeetings() {
  if (!calEvents) return;
  const now  = new Date();
  const soon = new Date(now.getTime() + 10 * 60 * 1000); // 10 min ahead

  calEvents.forEach(ev => {
    if (ev.allDay || !ev.start) return;

    const [h, m]  = ev.start.split(':').map(Number);
    const evTime  = new Date();
    evTime.setHours(h, m, 0, 0);

    const diffMs  = evTime - now;
    const diffMin = Math.round(diffMs / 60000);

    // Alert if meeting is 1â€“12 minutes away and not yet notified
    if (diffMin >= 1 && diffMin <= 12 && !notifiedMeetings.has(ev.id)) {
      notifiedMeetings.add(ev.id);
      showMeetingAlert(ev, diffMin);
    }
  });
}

let meetingAlertTimer = null;
function showMeetingAlert(ev, minsLeft) {
  const alert = document.getElementById('meetingAlert');
  document.getElementById('meetingAlertTitle').textContent = ev.title;
  document.getElementById('meetingAlertSub').textContent =
    `Ñ‡ĞµÑ€ĞµĞ· ${minsLeft} Ğ¼Ğ¸Ğ½ Â· ${ev.start}${ev.attendees > 1 ? ` Â· ${ev.attendees} ÑƒÑ‡Ğ°ÑÑ‚Ğ½.` : ''}`;

  if (ev.meetLink) {
    document.getElementById('meetingAlertTitle').style.cursor = 'pointer';
    document.getElementById('meetingAlertTitle').onclick = () => window.open(ev.meetLink, '_blank');
  }

  alert.classList.add('show');
  if (meetingAlertTimer) clearTimeout(meetingAlertTimer);
  meetingAlertTimer = setTimeout(() => alert.classList.remove('show'), 15000);
}

function closeMeetingAlert() {
  document.getElementById('meetingAlert').classList.remove('show');
  if (meetingAlertTimer) clearTimeout(meetingAlertTimer);
}

// Check for meetings every 60 seconds
setInterval(() => { if (calEvents) checkUpcomingMeetings(); }, 60 * 1000);

// â”€â”€ 4. Make renderIssueRow Jira-clickable on dashboard â”€â”€â”€â”€â”€
const _origRenderIssueRow = renderIssueRow;
window.renderIssueRow = function(issue) {
  if (issue.url) {
    return `<div class="issue-row" onclick="window.open('${issue.url}','_blank')" style="cursor:pointer">
      <div class="priority-dot ${priorityClass(issue.priority)}"></div>
      <div class="issue-key">${issue.key}</div>
      <div style="flex:1;min-width:0">
        <div class="issue-summary" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${issue.summary}</div>
        <div class="issue-project">${issue.project}</div>
      </div>
      <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    </div>`;
  }
  return _origRenderIssueRow(issue);
};

// Patch loadGmailMessages / loadCalendarEvents / loadTasks / loadJiraIssues
// to update badges after loading
const _origLoadGmail = loadGmailMessages;
window.loadGmailMessages = async function() {
  await _origLoadGmail();
  updateNavBadges();
};
const _origLoadCal = loadCalendarEvents;
window.loadCalendarEvents = async function() {
  await _origLoadCal();
  updateNavBadges();
  checkUpcomingMeetings();
};
const _origLoadTasks = loadTasks;
window.loadTasks = async function() {
  await _origLoadTasks();
};
const _origLoadJira = loadJiraIssues;
window.loadJiraIssues = async function() {
  await _origLoadJira();
  updateNavBadges();
};

// â”€â”€ 5. Override syncData to use patched loaders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.syncData = async function() {
  const btn  = document.getElementById('syncBtn');
  const sync = document.getElementById('lastSync');
  btn.classList.add('syncing');
  showToast('âŸ³ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...');

  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  jiraIssues    = null;
  render();

  await Promise.all([
    window.loadGmailMessages(),
    window.loadCalendarEvents(),
    window.loadTasks(),
    window.loadJiraIssues()
  ]);

  btn.classList.remove('syncing');
  const now = new Date();
  sync.textContent = 'Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  showToast('âœ“ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹');
  startAutoRefresh(); // reset timer after manual sync
};

// ============================================================
//  PHASE 3: LIGHT THEME + SKELETON LOADING
// ============================================================

// â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    document.getElementById('themeBtn').textContent = 'â˜€ï¸';
  }
}

// â”€â”€ Skeleton rows helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skeletonRows(n = 4) {
  return Array(n).fill(0).map((_, i) => `
    <div class="skeleton-row">
      <div class="skeleton skeleton-avatar"></div>
      <div class="skeleton-body">
        <div class="skeleton skeleton-line" style="width:${60 + (i % 3) * 15}%"></div>
        <div class="skeleton skeleton-line" style="width:${35 + (i % 2) * 20}%"></div>
      </div>
    </div>`).join('');
}

// â”€â”€ Patch loading states to use skeletons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origRenderEmailFullSkel = window.renderEmailFull;
window.renderEmailFull = function() {
  if (currentUser && gmailMessages === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="card-body">${skeletonRows(4)}</div>
    </div>`;
  }
  return _origRenderEmailFullSkel();
};

const _origRenderCalFullSkel = window.renderCalFull;
window.renderCalFull = function() {
  if (currentUser && calEvents === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--green)"></div>ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</div>
      </div>
      <div class="card-body">${skeletonRows(3)}</div>
    </div>`;
  }
  return _origRenderCalFullSkel();
};

const _origRenderTasksFullSkel = window.renderTasksFull;
window.renderTasksFull = function() {
  if (currentUser && realTasks === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      </div>
      <div class="card-body">${skeletonRows(4)}</div>
    </div>`;
  }
  return _origRenderTasksFullSkel();
};

const _origRenderJiraFullSkel = window.renderJiraFull;
window.renderJiraFull = function() {
  if (jiraCfgSet() && jiraIssues === null) {
    return `
    <div class="tabs">
      ${['Ğ’ÑĞµ','Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ','Ğ ĞµĞ²ÑŒÑ / Ğ¢ĞµÑÑ‚','Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ','Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾'].map((t,i)=>
        `<div class="tab${i===0?' active':''}">${t}</div>`).join('')}
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-body">${skeletonRows(5)}</div>
    </div>`;
  }
  return _origRenderJiraFullSkel();
};

// â”€â”€ Telegram Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendTelegramReport() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  if (!cfg.tgToken || !cfg.tgChatId) {
    showToast('âš  Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Telegram Bot Token Ğ¸ Chat ID Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…');
    openSettings();
    return;
  }

  const btn = document.getElementById('tgBtn');
  btn.classList.add('syncing');
  showToast('ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚...');

  try {
    const res = await fetch('/api/telegram/report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tgToken:   cfg.tgToken,
        tgChatId:  cfg.tgChatId,
        jiraDomain: cfg.jiraDomain,
        jiraEmail:  cfg.jiraEmail,
        jiraToken:  cfg.jiraToken
      })
    });
    const data = await res.json();
    if (data.ok) {
      showToast('âœ… ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Telegram!');
    } else {
      showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (data.error || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°'));
    }
  } catch (err) {
    showToast('âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚');
  } finally {
    btn.classList.remove('syncing');
  }
}

// Handle ?auth=success redirect
if (new URLSearchParams(location.search).get('auth') === 'success') {
  history.replaceState({}, '', '/');
}

// ============================================================
//  INIT
// ============================================================
initTheme();
document.getElementById('pageDate').textContent = fmt(currentDate);
render();
checkAuth();
startAutoRefresh();
setTimeout(updateNavBadges, 4000);
</script>
</body>
</html>
```