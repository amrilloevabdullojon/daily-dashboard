<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Report Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0a0c0f;
    --bg2:       #0f1318;
    --bg3:       #151a22;
    --bg4:       #1c2330;
    --border:    #1f2a38;
    --border2:   #263344;
    --text:      #e2e8f0;
    --muted:     #64748b;
    --muted2:    #94a3b8;
    --accent:    #3b82f6;
    --accent2:   #60a5fa;
    --green:     #22c55e;
    --yellow:    #eab308;
    --red:       #ef4444;
    --purple:    #a855f7;
    --cyan:      #06b6d4;
    --orange:    #f97316;
    --card-glow: 0 0 0 1px var(--border), 0 4px 24px rgba(0,0,0,0.4);
  }

  /* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
  body.light {
    --bg:      #f1f5f9;
    --bg2:     #ffffff;
    --bg3:     #f8fafc;
    --bg4:     #e2e8f0;
    --border:  #e2e8f0;
    --border2: #cbd5e1;
    --text:    #0f172a;
    --muted:   #94a3b8;
    --muted2:  #64748b;
    --accent2: #2563eb;
  }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .app { display: flex; min-height: 100vh; }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    width: 220px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px 0;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }
  .logo {
    padding: 0 24px 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .logo-mark {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .logo-mark span { color: var(--accent); }
  .logo-sub { font-size: 10px; color: var(--muted); margin-top: 2px; letter-spacing: 1px; text-transform: uppercase; }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 24px;
    color: var(--muted);
    cursor: pointer;
    transition: all .15s;
    font-size: 12px;
    letter-spacing: .3px;
    border-left: 2px solid transparent;
  }
  .nav-item:hover { color: var(--text); background: var(--bg3); }
  .nav-item.active { color: var(--accent2); border-left-color: var(--accent); background: rgba(59,130,246,.06); }
  .nav-icon { width: 16px; height: 16px; opacity: .7; }
  .nav-item.active .nav-icon { opacity: 1; }

  .sidebar-footer {
    margin-top: auto;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
  }
  .sync-btn {
    width: 100%;
    background: rgba(59,130,246,.1);
    border: 1px solid rgba(59,130,246,.25);
    color: var(--accent2);
    padding: 8px 12px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: .5px;
    transition: all .2s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }
  .sync-btn:hover { background: rgba(59,130,246,.18); }
  .sync-btn.syncing .sync-icon { animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .last-sync { font-size: 10px; color: var(--muted); text-align: center; margin-top: 8px; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main {
    margin-left: 220px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .topbar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 50;
  }
  .page-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: -.3px; }
  .page-date { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .date-nav { display: flex; align-items: center; gap: 8px; }
  .date-nav button {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--muted2);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .date-nav button:hover { border-color: var(--accent); color: var(--accent2); }
  .date-label { font-size: 12px; color: var(--text); min-width: 100px; text-align: center; }

  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: rgba(34,197,94,.1);
    border: 1px solid rgba(34,197,94,.2);
    color: var(--green);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 10px;
    letter-spacing: .5px;
  }
  .badge-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content { padding: 28px 32px; flex: 1; }

  /* ‚îÄ‚îÄ STAT ROW ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color .2s;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.blue::before  { background: var(--accent); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.yellow::before{ background: var(--yellow); }
  .stat-card.purple::before{ background: var(--purple); }
  .stat-card:hover { border-color: var(--border2); }

  .stat-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .stat-value { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 28px; letter-spacing: -1px; }
  .stat-value.blue   { color: var(--accent2); }
  .stat-value.green  { color: var(--green); }
  .stat-value.yellow { color: var(--yellow); }
  .stat-value.purple { color: var(--purple); }
  .stat-sub { font-size: 10px; color: var(--muted); margin-top: 4px; }

  /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .grid-3 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    display: flex; align-items: center; gap: 8px;
  }
  .card-title .dot {
    width: 8px; height: 8px; border-radius: 50%;
  }
  .card-count {
    font-size: 11px;
    color: var(--muted);
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 2px 8px;
    border-radius: 12px;
  }
  .card-body { padding: 0; }

  /* ‚îÄ‚îÄ JIRA ISSUES ‚îÄ‚îÄ */
  .issue-row {
    display: flex; align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
    cursor: pointer;
    transition: background .12s;
  }
  .issue-row:last-child { border-bottom: none; }
  .issue-row:hover { background: var(--bg3); }

  .issue-key {
    font-size: 11px;
    color: var(--accent2);
    font-weight: 500;
    min-width: 70px;
    letter-spacing: .3px;
  }
  .issue-summary { flex: 1; color: var(--text); font-size: 12px; }
  .issue-project { font-size: 10px; color: var(--muted); }

  .status-pill {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
    white-space: nowrap;
    letter-spacing: .3px;
  }
  .status-progress { background: rgba(59,130,246,.15); color: var(--accent2); border: 1px solid rgba(59,130,246,.3); }
  .status-review   { background: rgba(168,85,247,.15); color: var(--purple);  border: 1px solid rgba(168,85,247,.3); }
  .status-approval { background: rgba(249,115,22,.15); color: var(--orange);  border: 1px solid rgba(249,115,22,.3); }
  .status-todo     { background: rgba(100,116,139,.12); color: var(--muted2); border: 1px solid rgba(100,116,139,.25); }
  .status-done     { background: rgba(34,197,94,.12);  color: var(--green);  border: 1px solid rgba(34,197,94,.25); }

  .priority-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .p-high    { background: var(--red); }
  .p-medium  { background: var(--yellow); }
  .p-low     { background: var(--green); }

  /* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
  .event-row {
    display: flex; align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    gap: 14px;
  }
  .event-row:last-child { border-bottom: none; }
  .event-time {
    font-size: 11px;
    color: var(--muted2);
    min-width: 90px;
    font-feature-settings: "tnum";
  }
  .event-bar {
    width: 3px;
    border-radius: 2px;
    align-self: stretch;
    min-height: 20px;
    flex-shrink: 0;
  }
  .event-info { flex: 1; }
  .event-title { font-size: 12px; color: var(--text); }
  .event-meta  { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .event-duration {
    font-size: 11px;
    color: var(--muted);
    background: var(--bg3);
    padding: 2px 8px;
    border-radius: 10px;
  }

  /* ‚îÄ‚îÄ EMAILS ‚îÄ‚îÄ */
  .email-row {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background .12s;
    display: flex; gap: 12px; align-items: flex-start;
  }
  .email-row:last-child { border-bottom: none; }
  .email-row:hover { background: var(--bg3); }
  .email-avatar {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .email-body { flex: 1; min-width: 0; overflow: hidden; }
  .email-from    { font-size: 11px; color: var(--text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-from .email-addr { font-weight: 400; color: var(--muted); font-size: 10px; }
  .email-subject { font-size: 11px; color: var(--muted2); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-time    { font-size: 10px; color: var(--muted); white-space: nowrap; }
  .email-star { color: var(--yellow); font-size: 12px; }

  /* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
  .task-row {
    display: flex; align-items: center;
    padding: 11px 20px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
  }
  .task-row:last-child { border-bottom: none; }
  .task-check {
    width: 16px; height: 16px;
    border-radius: 4px;
    border: 1.5px solid var(--border2);
    flex-shrink: 0;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .task-check.done { background: var(--green); border-color: var(--green); }
  .task-check.done::after { content: '‚úì'; color: #fff; font-size: 9px; }
  .task-text { flex: 1; font-size: 12px; color: var(--text); }
  .task-text.done { text-decoration: line-through; color: var(--muted); }
  .task-due { font-size: 10px; color: var(--muted); }
  .task-due.overdue { color: var(--red); }

  /* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
  .chart-wrap { padding: 20px; }
  .mini-bar-chart { display: flex; align-items: flex-end; gap: 6px; height: 80px; }
  .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    transition: height .4s cubic-bezier(.4,0,.2,1), opacity .2s;
    cursor: pointer;
    min-height: 4px;
  }
  .bar:hover { opacity: .8; }
  .bar-label { font-size: 9px; color: var(--muted); letter-spacing: .3px; }

  /* Donut */
  .donut-wrap { display: flex; align-items: center; gap: 20px; padding: 20px; }
  svg.donut { flex-shrink: 0; }
  .donut-legend { display: flex; flex-direction: column; gap: 8px; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-count { color: var(--muted2); margin-left: auto; }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs { display: flex; border-bottom: 1px solid var(--border); }
  .tab {
    padding: 10px 20px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
    letter-spacing: .3px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent2); border-bottom-color: var(--accent); }

  /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
  .empty { padding: 32px 20px; text-align: center; color: var(--muted); font-size: 12px; }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ‚îÄ‚îÄ FADE IN ‚îÄ‚îÄ */
  .fade-in { animation: fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

  /* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
  .settings-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.6);
    z-index: 200;
    backdrop-filter: blur(4px);
  }
  .settings-overlay.open { display: flex; align-items: center; justify-content: center; }
  .settings-modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 14px;
    width: 420px;
    padding: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  .settings-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 20px; }
  .field-group { margin-bottom: 16px; }
  .field-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .field-input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    outline: none;
    transition: border-color .15s;
  }
  .field-input:focus { border-color: var(--accent); }
  .field-input::placeholder { color: var(--muted); }
  .modal-actions { display: flex; gap: 10px; margin-top: 24px; justify-content: flex-end; }
  .btn-primary {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 9px 20px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: background .15s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary {
    background: transparent;
    color: var(--muted2);
    border: 1px solid var(--border2);
    padding: 9px 20px;
    border-radius: 7px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: all .15s;
  }
  .btn-secondary:hover { color: var(--text); border-color: var(--border); }

  /* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 12px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(0,0,0,.4);
    transform: translateY(60px);
    opacity: 0;
    transition: all .3s cubic-bezier(.4,0,.2,1);
    z-index: 300;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show { transform: none; opacity: 1; }

  /* ‚îÄ‚îÄ NAV BADGE ‚îÄ‚îÄ */
  .nav-badge {
    margin-left: auto;
    background: var(--accent);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    min-width: 16px;
    height: 16px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    line-height: 1;
  }
  .nav-badge.red { background: var(--red); }

  /* ‚îÄ‚îÄ MEETING ALERT ‚îÄ‚îÄ */
  .meeting-alert {
    position: fixed;
    top: 20px; right: 20px;
    background: var(--bg3);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 14px 18px;
    font-size: 12px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(59,130,246,.25);
    z-index: 400;
    display: flex; align-items: center; gap: 12px;
    max-width: 300px;
    transform: translateX(340px);
    opacity: 0;
    transition: all .4s cubic-bezier(.4,0,.2,1);
  }
  .meeting-alert.show { transform: none; opacity: 1; }
  .meeting-alert-icon { font-size: 20px; flex-shrink: 0; }
  .meeting-alert-title { font-weight: 600; color: var(--accent2); font-size: 11px; }
  .meeting-alert-sub { font-size: 10px; color: var(--muted2); margin-top: 2px; }
  .meeting-alert-close {
    position: absolute; top: 8px; right: 10px;
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 14px; line-height: 1;
  }

  /* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
  .skeleton {
    background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
    border-radius: 4px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .skeleton-row { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
  .skeleton-avatar { width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0; }
  .skeleton-line { height: 10px; border-radius: 4px; }
  .skeleton-body { flex: 1; display: flex; flex-direction: column; gap: 6px; }

  /* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
  .theme-btn {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--muted2);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .theme-btn:hover { border-color: var(--accent); color: var(--accent2); }

  /* ‚îÄ‚îÄ AUTO-REFRESH INDICATOR ‚îÄ‚îÄ */
  .auto-refresh-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    display: inline-block;
    margin-left: 4px;
    animation: pulse 2s infinite;
  }

  /* ‚îÄ‚îÄ GOOGLE AUTH ‚îÄ‚îÄ */
  .google-btn {
    width: 100%;
    background: #fff;
    border: 1px solid #dadce0;
    color: #3c4043;
    padding: 8px 12px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: .3px;
    transition: all .2s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }
  .google-btn:hover { background: #f8f9fa; box-shadow: 0 1px 6px rgba(0,0,0,.2); }
  .google-btn svg { flex-shrink: 0; }

  .user-info {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 8px;
  }
  .user-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px;
    color: #fff; overflow: hidden; flex-shrink: 0;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-name { font-size: 11px; color: var(--muted2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .logout-btn {
    background: transparent; border: none; color: var(--muted); font-size: 10px;
    cursor: pointer; padding: 0; text-decoration: underline; font-family: inherit;
  }
  .logout-btn:hover { color: var(--red); }

  /* ‚îÄ‚îÄ LOADING SPINNER ‚îÄ‚îÄ */
  .loading-row {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 24px 20px; color: var(--muted); font-size: 12px;
  }
  @keyframes spin2 { to { transform: rotate(360deg); } }
  .spin { animation: spin2 .8s linear infinite; display: inline-block; }

  /* ‚îÄ‚îÄ GMAIL IMPROVEMENTS ‚îÄ‚îÄ */
  .email-filter-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 4px;
  }
  .email-filter-tab {
    padding: 10px 16px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
    letter-spacing: .3px;
    display: flex; align-items: center; gap: 5px;
  }
  .email-filter-tab:hover { color: var(--text); }
  .email-filter-tab.active { color: var(--accent2); border-bottom-color: var(--accent); }
  .email-filter-count {
    font-size: 9px;
    background: var(--bg4);
    padding: 1px 5px;
    border-radius: 8px;
    min-width: 16px;
    text-align: center;
  }
  .email-filter-tab.active .email-filter-count { background: rgba(59,130,246,.2); }
  .email-row-unread { background: rgba(59,130,246,.04); }
  .email-snippet-2 {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.5;
    max-height: 30px;
  }
  .email-unread-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ CALENDAR TIMELINE ‚îÄ‚îÄ */
  .cal-day-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 4px;
  }
  .cal-day-tab {
    padding: 10px 16px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
    letter-spacing: .3px;
  }
  .cal-day-tab:hover { color: var(--text); }
  .cal-day-tab.active { color: var(--accent2); border-bottom-color: var(--accent); }

  .timeline-wrap { padding: 16px 20px 20px; position: relative; }
  .timeline-line {
    position: absolute;
    left: 56px; top: 0; bottom: 0;
    width: 1px;
    background: linear-gradient(to bottom, transparent, var(--border) 10%, var(--border) 90%, transparent);
  }
  .timeline-event { display: flex; align-items: flex-start; gap: 0; margin-bottom: 16px; position: relative; }
  .timeline-event:last-child { margin-bottom: 0; }
  .timeline-time {
    width: 40px;
    font-size: 10px;
    color: var(--muted);
    text-align: right;
    padding-top: 10px;
    flex-shrink: 0;
    font-feature-settings: "tnum";
  }
  .timeline-dot-wrap {
    width: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 12px;
    flex-shrink: 0;
  }
  .timeline-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    border: 2px solid;
    background: var(--bg2);
    position: relative;
    z-index: 1;
    flex-shrink: 0;
  }
  .timeline-card {
    flex: 1;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    transition: border-color .15s, background .15s;
    position: relative;
    overflow: hidden;
  }
  .timeline-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--ev-color, #3b82f6);
  }
  .timeline-card:hover { border-color: var(--border2); background: var(--bg4); }
  .timeline-card.current {
    border-color: rgba(59,130,246,.4);
    background: rgba(59,130,246,.06);
    box-shadow: 0 0 0 1px rgba(59,130,246,.15);
  }
  .timeline-card-title { font-size: 12px; color: var(--text); font-weight: 500; margin-bottom: 4px; }
  .timeline-card-meta { font-size: 10px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
  .timeline-card-badge {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 8px;
    font-weight: 500;
  }
  .badge-now { background: rgba(59,130,246,.2); color: var(--accent2); }
  .badge-soon { background: rgba(234,179,8,.15); color: var(--yellow); }
  .badge-done { background: rgba(34,197,94,.1); color: var(--green); }

  /* Progress bar inside current meeting card */
  .timeline-progress-wrap {
    margin-top: 8px;
    background: var(--bg4);
    border-radius: 4px;
    height: 4px;
    overflow: hidden;
  }
  .timeline-progress-bar {
    height: 100%;
    border-radius: 4px;
    background: var(--accent);
    transition: width .5s ease;
  }
  .timeline-allday {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 11px; color: var(--muted2);
  }
  .timeline-allday-bar { width: 3px; height: 20px; border-radius: 2px; flex-shrink: 0; }

  @media (max-width: 900px) {
    .sidebar { width: 60px; }
    .sidebar .logo-mark, .sidebar .logo-sub, .sidebar .nav-item span, .sidebar-footer { display: none; }
    .nav-item { justify-content: center; padding: 14px; }
    .main { margin-left: 60px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .content { padding: 20px 16px; }
    .topbar { padding: 14px 16px; }
  }
</style>
</head>
<body>

<div class="app">

  <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark">daily<span>.</span>report</div>
      <div class="logo-sub">workspace hub</div>
    </div>

    <nav>
      <div class="nav-item active" onclick="setView('dashboard')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1" y="1" width="6" height="6" rx="1.5"/>
          <rect x="9" y="1" width="6" height="6" rx="1.5"/>
          <rect x="1" y="9" width="6" height="6" rx="1.5"/>
          <rect x="9" y="9" width="6" height="6" rx="1.5"/>
        </svg>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="setView('jira')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="6.5"/>
          <path d="M8 5v3.5l2 2"/>
        </svg>
        <span>Jira –∑–∞–¥–∞—á–∏</span>
        <span class="nav-badge" id="jiraBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('calendar')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1.5" y="2.5" width="13" height="12" rx="2"/>
          <path d="M1.5 6.5h13M5 1v3M11 1v3"/>
        </svg>
        <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        <span class="nav-badge" id="calBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('email')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1" y="3" width="14" height="10" rx="2"/>
          <path d="M1 5l7 5 7-5"/>
        </svg>
        <span>Gmail</span>
        <span class="nav-badge red" id="gmailBadge" style="display:none"></span>
      </div>
      <div class="nav-item" onclick="setView('tasks')">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M2 4h12M2 8h8M2 12h5"/>
          <circle cx="13" cy="11" r="2.5"/>
          <path d="M13 9.5v1.5l1 1"/>
        </svg>
        <span>Tasks</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      <!-- User block (shown when authenticated) -->
      <div id="userBlock" style="display:none">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="user-name" id="userName"></div>
        </div>
        <button class="sync-btn" id="syncBtn" onclick="syncData()">
          <svg class="sync-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M10 6A4 4 0 1 1 6 2M6 2l2-2M6 2l2 2"/>
          </svg>
          <span>Sync</span>
        </button>
        <div class="last-sync" id="lastSync">–ø–æ—Å–ª–µ–¥–Ω–∏–π: —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
        <button class="sync-btn" onclick="sendTelegramReport()" id="tgBtn" style="margin-top:8px;background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.25);color:var(--green)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12L7.88 13.67l-2.967-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.953l-.524-.064z"/>
          </svg>
          <span>–û—Ç—á—ë—Ç –≤ Telegram</span>
        </button>
        <button class="logout-btn" onclick="logout()" style="margin-top:8px;width:100%;text-align:center">–í—ã–π—Ç–∏</button>
      </div>

      <!-- Login block (shown when not authenticated) -->
      <div id="loginBlock">
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:.5px">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨ GMAIL</div>
        <a href="/api/auth/google" class="google-btn">
          <svg width="14" height="14" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </a>
      </div>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="page-date" id="pageDate"></div>
      </div>
      <div class="topbar-right">
        <div class="date-nav">
          <button onclick="changeDate(-1)">‚Äπ</button>
          <div class="date-label" id="dateLabel"></div>
          <button onclick="changeDate(1)">‚Ä∫</button>
        </div>
        <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
        <div class="badge"><div class="badge-dot"></div>LIVE</div>
        <button class="btn-secondary" onclick="openSettings()" style="font-size:11px;padding:6px 14px;">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>

    <div class="content" id="mainContent"></div>
  </main>
</div>

<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-modal">
    <div class="settings-title">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>

    <div class="field-group">
      <div class="field-label">Jira Domain</div>
      <input class="field-input" id="cfgJiraDomain" placeholder="your-company.atlassian.net">
    </div>
    <div class="field-group">
      <div class="field-label">Jira Email</div>
      <input class="field-input" id="cfgJiraEmail" type="email" placeholder="your@email.com">
    </div>
    <div class="field-group">
      <div class="field-label">Jira API Token</div>
      <input class="field-input" id="cfgJiraToken" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="field-group">
      <div class="field-label">Telegram Bot Token</div>
      <input class="field-input" id="cfgTgToken" type="password" placeholder="123456789:ABC...">
    </div>
    <div class="field-group">
      <div class="field-label">Telegram Chat ID</div>
      <input class="field-input" id="cfgTgChatId" placeholder="-100xxxxxxxxxx">
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Meeting Alert -->
<div class="meeting-alert" id="meetingAlert">
  <div class="meeting-alert-icon">üìÖ</div>
  <div>
    <div class="meeting-alert-title" id="meetingAlertTitle"></div>
    <div class="meeting-alert-sub" id="meetingAlertSub"></div>
  </div>
  <button class="meeting-alert-close" onclick="closeMeetingAlert()">‚úï</button>
</div>

<script>
// ============================================================
//  DATA (demo ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã)
// ============================================================
const DATA = {
  jira: [
    { key:'PROJ-142', summary:'–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è OAuth 2.0 —Å –≤–Ω–µ—à–Ω–∏–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º', status:'In Progress', priority:'High',    project:'Backend API',  updated:'10 –º–∏–Ω –Ω–∞–∑–∞–¥' },
    { key:'PROJ-138', summary:'–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',            status:'In Progress', priority:'Medium',  project:'Backend API',  updated:'2 —á –Ω–∞–∑–∞–¥'    },
    { key:'PROJ-151', summary:'–î–∏–∑–∞–π–Ω-—Ä–µ–≤—å—é —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫',               status:'Review',      priority:'Medium',  project:'Mobile App',   updated:'3 —á –Ω–∞–∑–∞–¥'    },
    { key:'PROJ-129', summary:'–ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –º–æ–¥—É–ª—è –æ–ø–ª–∞—Ç—ã',      status:'Review',      priority:'High',    project:'Backend API',  updated:'–≤—á–µ—Ä–∞'        },
    { key:'PROJ-155', summary:'–ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –∑–∞ Q4',                        status:'To Do',       priority:'Low',     project:'Analytics',    updated:'–≤—á–µ—Ä–∞'        },
    { key:'PROJ-147', summary:'–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API v3',               status:'To Do',       priority:'Low',     project:'Backend API',  updated:'2 –¥–Ω—è –Ω–∞–∑–∞–¥'  },
    { key:'PROJ-160', summary:'–ë–∞–≥: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–∞—Ç –≤ –æ—Ç—á—ë—Ç–∞—Ö',     status:'To Do',       priority:'High',    project:'Analytics',    updated:'1 —á –Ω–∞–∑–∞–¥'    },
    { key:'PROJ-135', summary:'–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD pipeline –¥–ª—è staging',       status:'Done',        priority:'Medium',  project:'DevOps',       updated:'—Å–µ–≥–æ–¥–Ω—è'      }
  ],
  events: [
    { title:'Daily Standup',         start:'09:00', end:'09:30', color:'#3b82f6', attendees:6,  type:'recurring'  },
    { title:'Jira Sprint Review',    start:'11:00', end:'12:00', color:'#a855f7', attendees:12, type:'team'       },
    { title:'1:1 —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º',   start:'14:00', end:'14:30', color:'#06b6d4', attendees:2,  type:'personal'   },
    { title:'–ö–æ–¥-—Ä–µ–≤—å—é —Å–µ—Å—Å–∏—è',      start:'15:30', end:'16:30', color:'#22c55e', attendees:4,  type:'technical'  },
    { title:'Retrospective Q4',      start:'17:00', end:'18:00', color:'#f97316', attendees:8,  type:'planning'   }
  ],
  emails: [
    { from:'–ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤',   addr:'a.ivanov@corp.com',   subject:'Re: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–∞ PROJ-142',          time:'10:24', starred:true,  color:'#3b82f6', init:'–ê–ò' },
    { from:'–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞',    addr:'m.petrova@corp.com',  subject:'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ: Sprint Planning –ø—è—Ç–Ω–∏—Ü–∞ 11:00', time:'09:47', starred:true,  color:'#a855f7', init:'–ú–ü' },
    { from:'Jira',             addr:'noreply@atlassian.com',subject:'PROJ-155 –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–∞ –≤–∞—Å',                 time:'09:15', starred:false, color:'#1c2330', init:'J'  },
    { from:'DevOps Bot',       addr:'devops@corp.com',     subject:'‚úÖ Deployment to staging —É—Å–ø–µ—à–Ω–æ',           time:'08:53', starred:false, color:'#22c55e', init:'D'  },
    { from:'–î–º–∏—Ç—Ä–∏–π –°–æ–∫–æ–ª–æ–≤', addr:'d.sokolov@corp.com',  subject:'–í–æ–ø—Ä–æ—Å –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å–µ—Ä–≤–∏—Å–∞',             time:'–≤—á–µ—Ä–∞', starred:false, color:'#f97316', init:'–î–°' }
  ],
  tasks: [
    { text:'–ó–∞–≤–µ—Ä—à–∏—Ç—å OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é',          due:'—Å–µ–≥–æ–¥–Ω—è',   done:false, overdue:false },
    { text:'–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ–¥-—Ä–µ–≤—å—é PR #847',           due:'—Å–µ–≥–æ–¥–Ω—è',   done:false, overdue:false },
    { text:'–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è payment service',  due:'–∑–∞–≤—Ç—Ä–∞',    done:false, overdue:false },
    { text:'–û–±–Ω–æ–≤–∏—Ç—å Confluence —Å—Ç—Ä–∞–Ω–∏—Ü—É',        due:'–ø—Ç, 19 —Ñ–µ–≤',done:false, overdue:false },
    { text:'–°–æ–∑–≤–æ–Ω–∏—Ç—å—Å—è —Å –∫–æ–º–∞–Ω–¥–æ–π –º–æ–±–∞–π–ª',       due:'–≤—á–µ—Ä–∞',     done:false, overdue:true  },
    { text:'Review –¥–∏–∑–∞–π–Ω-–º–∞–∫–µ—Ç–∞ v2',             due:'—Å—Ä–µ–¥–∞',     done:true,  overdue:false },
    { text:'–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é',         due:'–ø—è—Ç–Ω–∏—Ü–∞',   done:true,  overdue:false }
  ],
  weekActivity: [12,8,15,6,18,10,14]
};

// ============================================================
//  STATE
// ============================================================
let currentView = 'dashboard';
let currentDate = new Date();
let taskState   = DATA.tasks.map(t => t.done);

// ============================================================
//  UTILS
// ============================================================
function fmt(d) {
  const days  = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
  const months= ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return days[d.getDay()] + ', ' + d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
}
function fmtShort(d) {
  const months=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return d.getDate() + ' ' + months[d.getMonth()];
}
function duration(start, end) {
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  const mins=(eh*60+em)-(sh*60+sm);
  return mins>=60 ? Math.floor(mins/60)+'—á '+(mins%60?mins%60+'–º':'') : mins+'–º';
}
function statusClass(s) {
  const sl = s.toLowerCase();
  if(sl.includes('progress')||sl.includes('dev')||sl.includes('—Ä–∞–∑—Ä–∞–±–æ—Ç')) return 'status-progress';
  if(sl.includes('approval')||sl.includes('approving')) return 'status-approval';
  if(sl.includes('review')||sl.includes('test')) return 'status-review';
  if(sl==='to do'||sl==='open'||sl==='backlog'||sl.includes('–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é')||sl.includes('not doing')||sl.includes('–æ—Ç–º–µ–Ω')) return 'status-todo';
  if(sl==='done'||sl==='closed'||sl==='–≥–æ—Ç–æ–≤–æ'||sl.includes('complete')||sl.includes('resolved')) return 'status-done';
  return 'status-todo';
}
function priorityClass(p) {
  if(p==='High'||p==='Highest') return 'p-high';
  if(p==='Low'||p==='Lowest')   return 'p-low';
  return 'p-medium';
}
function statusLabel(s) {
  const m={
    'In Progress':'–í —Ä–∞–±–æ—Ç–µ','Review':'–ù–∞ —Ä–µ–≤—å—é','To Do':'–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é','Done':'–ì–æ—Ç–æ–≤–æ',
    'Open':'–û—Ç–∫—Ä—ã—Ç–∞','Backlog':'–ë—ç–∫–ª–æ–≥','Testing':'–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
    'Needs Approval':'–û–∂–∏–¥–∞–µ—Ç –∞–ø—Ä—É–≤','Not Doing':'–ù–µ –¥–µ–ª–∞–µ–º','Closed':'–ó–∞–∫—Ä—ã—Ç–∞',
    'In Review':'–ù–∞ —Ä–µ–≤—å—é','Resolved':'–†–µ—à–µ–Ω–æ'
  };
  return m[s] || s;
}

// Groups for tab filtering ‚Äî maps tab index to status matcher function
function jiraStatusGroup(status) {
  const sl = status.toLowerCase();
  if(sl.includes('progress')||sl.includes('dev')||sl.includes('—Ä–∞–∑—Ä–∞–±–æ—Ç')) return 'inprogress';
  if(sl.includes('approval')||sl.includes('approving')) return 'approval';
  if(sl.includes('review')||sl.includes('test')) return 'review';
  if(sl==='done'||sl==='closed'||sl==='–≥–æ—Ç–æ–≤–æ'||sl.includes('complete')||sl.includes('resolved')) return 'done';
  return 'todo'; // To Do, Not Doing, Open, Backlog etc
}

// ============================================================
//  RENDER
// ============================================================
function render() {
  const el = document.getElementById('mainContent');
  el.className = 'content fade-in';
  void el.offsetWidth;

  const titles = {dashboard:'Dashboard', jira:'Jira –∑–∞–¥–∞—á–∏', calendar:'–ö–∞–ª–µ–Ω–¥–∞—Ä—å', email:'Gmail', tasks:'Google Tasks'};
  document.getElementById('pageTitle').textContent = titles[currentView];
  document.getElementById('pageDate').textContent  = fmt(currentDate);
  document.getElementById('dateLabel').textContent = fmtShort(currentDate);

  switch(currentView) {
    case 'dashboard': el.innerHTML = renderDashboard(); break;
    case 'jira':      el.innerHTML = (window.renderJiraFull  || renderJiraFull)();  break;
    case 'calendar':  el.innerHTML = (window.renderCalFull   || renderCalFull)();   break;
    case 'email':     el.innerHTML = (window.renderEmailFull || renderEmailFull)(); break;
    case 'tasks':     el.innerHTML = (window.renderTasksFull || renderTasksFull)(); break;
  }

  // sidebar active
  document.querySelectorAll('.nav-item').forEach((n,i)=>{
    n.classList.remove('active');
    if(['dashboard','jira','calendar','email','tasks'][i]===currentView) n.classList.add('active');
  });

  // bind task toggles
  document.querySelectorAll('.task-check').forEach((el,i)=>{
    el.addEventListener('click', ()=>{ taskState[i]=!taskState[i]; render(); });
  });
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  // Stat values: use real data when authed, fallback to mock when not authed
  const jiraInProgress  = jiraIssues  ? jiraIssues.filter(j=>jiraStatusGroup(j.status)==='inprogress').length
                                       : DATA.jira.filter(j=>j.status==='In Progress').length;
  const jiraOnReview    = jiraIssues  ? jiraIssues.filter(j=>jiraStatusGroup(j.status)==='review'||jiraStatusGroup(j.status)==='approval').length
                                       : DATA.jira.filter(j=>j.status==='Review').length;
  const calCount        = calEvents   ? calEvents.length           : DATA.events.length;
  const calMeet         = calEvents   ? calEvents.filter(e=>e.meetLink).length+' —Å Meet-—Å—Å—ã–ª–∫–æ–π' : DATA.events.length+' –≤—Å—Ç—Ä–µ—á';
  const gmailCount      = gmailMessages ? gmailMessages.length     : DATA.emails.length;
  const gmailUnread     = gmailMessages ? gmailMessages.filter(m=>m.unread).length+' –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö' : DATA.emails.filter(e=>e.starred).length+' –≤–∞–∂–Ω—ã—Ö';
  const taskPending     = realTasks   ? realTasks.filter(t=>!t.done).length   : DATA.tasks.filter(t=>!t.done).length;
  const taskSub         = realTasks   ? realTasks.filter(t=>t.overdue&&!t.done).length+' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'
                                       : DATA.tasks.filter(t=>t.done).length+' –∑–∞–≤–µ—Ä—à–µ–Ω–æ';

  // Stat loading spinners ‚Äî only when authenticated but data still loading
  const jiraVal  = (jiraIssues === null)    ? '<span class="spin" style="font-size:20px">‚ü≥</span>' : jiraInProgress;
  const calVal   = (currentUser && calEvents === null)   ? '<span class="spin" style="font-size:20px">‚ü≥</span>' : calCount;
  const mailVal  = (currentUser && gmailMessages === null)? '<span class="spin" style="font-size:20px">‚ü≥</span>' : gmailCount;
  const taskVal  = (currentUser && realTasks === null)   ? '<span class="spin" style="font-size:20px">‚ü≥</span>' : taskPending;

  // Jira active count for card header
  const jiraActiveCount = jiraIssues
    ? jiraIssues.filter(j=>jiraStatusGroup(j.status)!=='done').length
    : DATA.jira.filter(j=>j.status!=='Done').length;

  // Calendar card body
  let calCardBody;
  if (currentUser && calEvents === null) {
    calCardBody = `<div class="card-body">${skeletonRows(3)}</div>`;
  } else if (currentUser && calEvents && calEvents.length === 0) {
    calCardBody = '<div class="empty">–°–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç üéâ</div>';
  } else if (currentUser && calEvents) {
    calCardBody = `<div class="card-body">${calEvents.slice(0,5).map(renderEventRow).join('')}</div>`;
  } else {
    // not authenticated ‚Äî show mock placeholder
    calCardBody = `<div class="card-body">${DATA.events.map(renderEventRow).join('')}</div>`;
  }

  return `
  <div class="stats-row">
    <div class="stat-card blue">
      <div class="stat-label">Jira –í —Ä–∞–±–æ—Ç–µ</div>
      <div class="stat-value blue">${jiraVal}</div>
      <div class="stat-sub">+${jiraOnReview} —Ä–µ–≤—å—é / –∞–ø—Ä—É–≤</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">–í—Å—Ç—Ä–µ—á–∏ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="stat-value green">${calVal}</div>
      <div class="stat-sub">${calMeet}</div>
    </div>
    <div class="stat-card yellow">
      <div class="stat-label">–ù–æ–≤—ã—Ö –ø–∏—Å–µ–º</div>
      <div class="stat-value yellow">${mailVal}</div>
      <div class="stat-sub">${gmailUnread}</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-label">–ó–∞–¥–∞—á–∏</div>
      <div class="stat-value purple">${taskVal}</div>
      <div class="stat-sub">${taskSub}</div>
    </div>
  </div>

  <div class="grid-3">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>–ê–∫—Ç–∏–≤–Ω—ã–µ Jira –∑–∞–¥–∞—á–∏</div>
        <div class="card-count">${jiraActiveCount}</div>
      </div>
      <div class="card-body">
        ${jiraIssues === null
          ? skeletonRows(4)
          : !jiraCfgSet()
            ? '<div class="empty" style="padding:20px">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Jira –≤ <span style="color:var(--accent2);cursor:pointer" onclick="openSettings()">–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚öô</span></div>'
            : jiraIssues.filter(j=>jiraStatusGroup(j.status)!=='done').slice(0,5).map(renderIssueRow).join('') || '<div class="empty">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç</div>'
        }
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--purple)"></div>–°—Ç–∞—Ç—É—Å—ã</div>
      </div>
      ${renderDonut()}
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--green)"></div>–í—Å—Ç—Ä–µ—á–∏ —Å–µ–≥–æ–¥–Ω—è</div>
        <div class="card-count">${currentUser && calEvents ? calEvents.length : DATA.events.length}</div>
      </div>
      ${calCardBody}
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
      </div>
      ${renderBarChart()}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ JIRA FULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderJiraFull() {
  const statuses = ['In Progress','Review','To Do','Done'];
  const labels   = {  'In Progress':'–í —Ä–∞–±–æ—Ç–µ','Review':'–ù–∞ —Ä–µ–≤—å—é','To Do':'–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é','Done':'–ì–æ—Ç–æ–≤–æ'};
  const colors   = {  'In Progress':var_accent,'Review':var_purple,'To Do':var_muted,'Done':var_green};

  return `
  <div class="tabs">
    ${['–í—Å–µ','–í —Ä–∞–±–æ—Ç–µ','–ù–∞ —Ä–µ–≤—å—é','–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é','–ì–æ—Ç–æ–≤–æ'].map((t,i)=>`
      <div class="tab${i===0?' active':''}" onclick="filterJira(${i},this)">${t}</div>`).join('')}
  </div>
  <div class="card" style="margin-top:16px" id="jiraList">
    ${DATA.jira.map(renderIssueRowFull).join('')}
  </div>`;
}

// ‚îÄ‚îÄ CAL FULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--green)"></div>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–Ω—è</div>
      <div class="card-count">${DATA.events.length} –≤—Å—Ç—Ä–µ—á</div>
    </div>
    <div class="card-body">${DATA.events.map(renderEventRowFull).join('')}</div>
  </div>`;
}

// ‚îÄ‚îÄ EMAIL FULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEmailFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>–í—Ö–æ–¥—è—â–∏–µ –ø–∏—Å—å–º–∞</div>
      <div class="card-count">${DATA.emails.length}</div>
    </div>
    <div class="card-body">${DATA.emails.map(renderEmailRow).join('')}</div>
  </div>`;
}

// ‚îÄ‚îÄ TASKS FULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTasksFull() {
  return `
  <div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      <div class="card-count">${taskState.filter(Boolean).length}/${taskState.length} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="card-body">${DATA.tasks.map((t,i)=>renderTaskRow(t,i)).join('')}</div>
  </div>`;
}

// ‚îÄ‚îÄ COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderIssueRow(issue) {
  return `<div class="issue-row">
    <div class="priority-dot ${priorityClass(issue.priority)}"></div>
    <div class="issue-key">${issue.key}</div>
    <div style="flex:1;min-width:0">
      <div class="issue-summary" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${issue.summary}</div>
      <div class="issue-project">${issue.project}</div>
    </div>
    <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
  </div>`;
}

function renderIssueRowFull(issue) {
  return `<div class="issue-row" data-status="${issue.status}">
    <div class="priority-dot ${priorityClass(issue.priority)}"></div>
    <div class="issue-key">${issue.key}</div>
    <div style="flex:1;min-width:0">
      <div class="issue-summary">${issue.summary}</div>
      <div class="issue-project">${issue.project} ¬∑ ${issue.updated}</div>
    </div>
    <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    <span style="font-size:10px;color:var(--muted);margin-left:4px">${issue.priority}</span>
  </div>`;
}

function renderEventRow(e) {
  const dur = duration(e.start,e.end);
  return `<div class="event-row">
    <div class="event-time">${e.start} ‚Äì ${e.end}</div>
    <div class="event-bar" style="background:${e.color}"></div>
    <div class="event-info">
      <div class="event-title">${e.title}</div>
      <div class="event-meta">${e.attendees} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
    </div>
    <div class="event-duration">${dur}</div>
  </div>`;
}

function renderEventRowFull(e) {
  const dur = duration(e.start,e.end);
  return `<div class="event-row">
    <div class="event-time">${e.start} ‚Äì ${e.end}</div>
    <div class="event-bar" style="background:${e.color}"></div>
    <div class="event-info">
      <div class="event-title">${e.title}</div>
      <div class="event-meta">${e.attendees} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ¬∑ ${e.type}</div>
    </div>
    <div class="event-duration">${dur}</div>
  </div>`;
}

function renderEmailRow(e) {
  return `<div class="email-row">
    <div class="email-avatar" style="background:${e.color}20;color:${e.color}">${e.init}</div>
    <div class="email-body">
      <div class="email-from">${e.from} <span style="color:var(--muted);font-weight:400">&lt;${e.addr}&gt;</span></div>
      <div class="email-subject">${e.subject}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
      <div class="email-time">${e.time}</div>
      ${e.starred ? '<div class="email-star">‚òÖ</div>' : ''}
    </div>
  </div>`;
}

function renderTaskRow(t,i) {
  const done = taskState[i];
  return `<div class="task-row">
    <div class="task-check ${done?'done':''}"></div>
    <div class="task-text ${done?'done':''}">${t.text}</div>
    <div class="task-due ${t.overdue&&!done?'overdue':''}">${t.due}</div>
  </div>`;
}

function renderDonut() {
  const src = jiraIssues || DATA.jira;
  const groups = {
    '–í —Ä–∞–±–æ—Ç–µ':    src.filter(j=>jiraStatusGroup(j.status)==='inprogress').length,
    '–†–µ–≤—å—é/–ê–ø—Ä—É–≤': src.filter(j=>jiraStatusGroup(j.status)==='review'||jiraStatusGroup(j.status)==='approval').length,
    '–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é':src.filter(j=>jiraStatusGroup(j.status)==='todo').length,
    '–ì–æ—Ç–æ–≤–æ':      src.filter(j=>jiraStatusGroup(j.status)==='done').length
  };
  const colors = ['#3b82f6','#a855f7','#64748b','#22c55e'];
  const total  = Object.values(groups).reduce((a,b)=>a+b,0);

  let offset=0, paths='';
  const R=30,cx=40,cy=40,stroke=10;
  const circ=2*Math.PI*R;

  Object.values(groups).forEach((v,i)=>{
    const dash = (v/total)*circ;
    const rot  = offset*(360/total);
    paths += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${colors[i]}"
      stroke-width="${stroke}" stroke-dasharray="${dash} ${circ-dash}"
      stroke-dashoffset="${circ/4-offset/total*circ}"
      transform="rotate(${rot-90} ${cx} ${cy})" style="transition:all .5s"/>`;
    offset+=v;
  });

  const legend = Object.entries(groups).map(([label,count],i)=>`
    <div class="legend-item">
      <div class="legend-dot" style="background:${colors[i]}"></div>
      <span>${label}</span>
      <span class="legend-count">${count}</span>
    </div>`).join('');

  return `<div class="donut-wrap">
    <svg class="donut" width="80" height="80" viewBox="0 0 80 80">${paths}
      <text x="40" y="44" text-anchor="middle" fill="#e2e8f0" font-family="Syne,sans-serif" font-size="14" font-weight="700">${total}</text>
    </svg>
    <div class="donut-legend">${legend}</div>
  </div>`;
}

function renderBarChart() {
  const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
  const max  = Math.max(...DATA.weekActivity);
  const today= new Date().getDay();
  const bars = DATA.weekActivity.map((v,i)=>{
    const h    = Math.round((v/max)*70);
    const isT  = i===(today===0?6:today-1);
    const color= isT ? '#3b82f6' : '#1c2330';
    const bord = isT ? '1px solid rgba(59,130,246,.4)' : '1px solid var(--border)';
    return `<div class="bar-col">
      <div class="bar" style="height:${h}px;background:${color};border:${bord};" title="${v} –∑–∞–¥–∞—á"></div>
      <div class="bar-label">${days[i]}</div>
    </div>`;
  }).join('');
  return `<div class="chart-wrap"><div class="mini-bar-chart">${bars}</div></div>`;
}

// ‚îÄ‚îÄ CSS VARS for JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const var_accent='#3b82f6',var_purple='#a855f7',var_green='#22c55e',var_muted='#64748b';

// ============================================================
//  ACTIONS
// ============================================================
function setView(v) {
  currentView = v;
  // Reset per-view filter state when switching tabs
  if (v !== 'email')    window._emailFilter   = 'all';
  if (v !== 'calendar') window._calDayOffset  = 0;
  render();
}

function changeDate(d) {
  currentDate = new Date(currentDate);
  currentDate.setDate(currentDate.getDate()+d);
  render();
}

function filterJira(idx, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  // idx: 0=–≤—Å–µ, 1=–≤ —Ä–∞–±–æ—Ç–µ, 2=—Ä–µ–≤—å—é/—Ç–µ—Å—Ç, 3=–Ω–∞ –∞–ø—Ä—É–≤, 4=–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é, 5=–≥–æ—Ç–æ–≤–æ
  const groupMap = [null,'inprogress','review','approval','todo','done'];
  const filter   = groupMap[idx];
  document.querySelectorAll('#jiraList .issue-row').forEach(row=>{
    const group = jiraStatusGroup(row.dataset.status || '');
    row.style.display = (!filter || group === filter) ? '' : 'none';
  });
}

async function syncData() {
  const btn  = document.getElementById('syncBtn');
  const sync = document.getElementById('lastSync');
  btn.classList.add('syncing');
  showToast('‚ü≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...');

  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  jiraIssues    = null;
  render();

  await Promise.all([
    loadGmailMessages(),
    loadCalendarEvents(),
    loadTasks(),
    loadJiraIssues()
  ]);

  btn.classList.remove('syncing');
  const now = new Date();
  sync.textContent = '–ø–æ—Å–ª–µ–¥–Ω–∏–π: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  showToast('‚úì –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
}

function openSettings() {
  const cfg = JSON.parse(localStorage.getItem('drCfg')||'{}');
  document.getElementById('cfgJiraDomain').value = cfg.jiraDomain||'';
  document.getElementById('cfgJiraEmail').value  = cfg.jiraEmail||'';
  document.getElementById('cfgJiraToken').value  = cfg.jiraToken||'';
  document.getElementById('cfgTgToken').value    = cfg.tgToken||'';
  document.getElementById('cfgTgChatId').value   = cfg.tgChatId||'';
  document.getElementById('settingsOverlay').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
}
function saveSettings() {
  const cfg = {
    jiraDomain: document.getElementById('cfgJiraDomain').value.trim(),
    jiraEmail:  document.getElementById('cfgJiraEmail').value.trim(),
    jiraToken:  document.getElementById('cfgJiraToken').value.trim(),
    tgToken:    document.getElementById('cfgTgToken').value.trim(),
    tgChatId:   document.getElementById('cfgTgChatId').value.trim()
  };
  localStorage.setItem('drCfg', JSON.stringify(cfg));
  closeSettings();
  showToast('‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  // Reload Jira with new credentials
  loadJiraIssues();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2500);
}

// ============================================================
//  AUTH & REAL DATA
// ============================================================
let currentUser    = null;
let gmailMessages  = null; // null = loading, [] = empty
let calEvents      = null;
let realTasks      = null;
let jiraIssues     = null; // null = loading, [] = empty

async function checkAuth() {
  try {
    const res  = await fetch('/api/auth/me');
    const data = await res.json();
    if (data.authenticated) {
      currentUser = data;
      showUserBlock(data);
      // Load all Google data in parallel
      loadGmailMessages();
      loadCalendarEvents();
      loadTasks();
    } else {
      showLoginBlock();
    }
  } catch {
    showLoginBlock();
  }
  // Jira uses its own credentials ‚Äî load independently of Google auth
  loadJiraIssues();
}

async function loadJiraIssues() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  if (!cfg.jiraDomain || !cfg.jiraEmail || !cfg.jiraToken) {
    jiraIssues = []; // no credentials ‚Äî show setup prompt
    render();
    return;
  }
  jiraIssues = null; // loading
  render();
  try {
    const res  = await fetch('/api/jira/issues', {
      headers: {
        'x-jira-domain': cfg.jiraDomain,
        'x-jira-email':  cfg.jiraEmail,
        'x-jira-token':  cfg.jiraToken
      }
    });
    const data = await res.json();
    if (data.issues) {
      jiraIssues = data.issues;
    } else {
      jiraIssues = [];
      console.error('Jira error:', data.error);
    }
    render();
  } catch (err) {
    console.error('Failed to load Jira:', err);
    jiraIssues = [];
    render();
  }
}

async function loadCalendarEvents() {
  try {
    const res  = await fetch('/api/calendar/events');
    const data = await res.json();
    if (data.events) {
      calEvents = data.events;
      render();
    }
  } catch (err) {
    console.error('Failed to load Calendar:', err);
  }
}

async function loadTasks() {
  try {
    const res  = await fetch('/api/tasks/list');
    const data = await res.json();
    if (data.tasks) {
      realTasks  = data.tasks;
      taskState  = data.tasks.map(t => t.done);
      render();
    }
  } catch (err) {
    console.error('Failed to load Tasks:', err);
  }
}

function showUserBlock(user) {
  document.getElementById('loginBlock').style.display = 'none';
  document.getElementById('userBlock').style.display  = 'block';
  document.getElementById('userName').textContent = user.name || user.email;
  const avatar = document.getElementById('userAvatar');
  if (user.picture) {
    avatar.innerHTML = `<img src="${user.picture}" alt="">`;
  } else {
    avatar.textContent = (user.name || user.email || '?')[0].toUpperCase();
  }
}

function showLoginBlock() {
  document.getElementById('loginBlock').style.display = 'block';
  document.getElementById('userBlock').style.display  = 'none';
}

async function loadGmailMessages() {
  try {
    const res  = await fetch('/api/gmail/messages');
    const data = await res.json();
    if (data.messages) {
      gmailMessages = data.messages;
      render();
    }
  } catch (err) {
    console.error('Failed to load Gmail:', err);
  }
}

function logout() {
  document.cookie = 'gauth=; Max-Age=0; Path=/';
  currentUser   = null;
  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  showLoginBlock();
  render();
}

function jiraCfgSet() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  return !!(cfg.jiraDomain && cfg.jiraEmail && cfg.jiraToken);
}

// ‚îÄ‚îÄ OVERRIDE renderEmailFull to use real data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _renderEmailFull = renderEmailFull;
window.renderEmailFull = function() {
  if (!currentUser) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="empty" style="padding:40px 20px">
        <div style="margin-bottom:12px;font-size:24px">üì¨</div>
        <div style="margin-bottom:16px">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Gmail –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–∏—Å–µ–º</div>
        <a href="/api/auth/google" class="google-btn" style="display:inline-flex;width:auto;padding:10px 20px">
          <svg width="14" height="14" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </a>
      </div>
    </div>`;
  }

  if (gmailMessages === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="loading-row"><span class="spin">‚ü≥</span> –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∏—Å—å–º–∞...</div>
    </div>`;
  }

  if (gmailMessages.length === 0) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail</div>
      </div>
      <div class="empty">–í—Ö–æ–¥—è—â–∏–µ –ø—É—Å—Ç—ã</div>
    </div>`;
  }

  const rows = gmailMessages.map(m => {
    const initials = (m.from || '?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const colors   = ['#3b82f6','#a855f7','#22c55e','#f97316','#06b6d4','#ef4444'];
    const color    = colors[m.from.charCodeAt(0) % colors.length];
    const timeStr  = m.date ? new Date(m.date).toLocaleTimeString('ru', {hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="email-row">
      <div class="email-avatar" style="background:${color}20;color:${color}">${initials}</div>
      <div class="email-body">
        <div class="email-from" style="${m.unread?'font-weight:600':''}">${m.from}
          <span style="color:var(--muted);font-weight:400">&lt;${m.email}&gt;</span>
        </div>
        <div class="email-subject" style="${m.unread?'color:var(--text)':''}">${m.subject}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.snippet}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="email-time">${timeStr}</div>
        ${m.starred ? '<div class="email-star">‚òÖ</div>' : ''}
        ${m.unread  ? '<div style="width:7px;height:7px;border-radius:50%;background:var(--accent)"></div>' : ''}
      </div>
    </div>`;
  }).join('');

  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--yellow)"></div>Gmail ‚Äî –≤—Ö–æ–¥—è—â–∏–µ</div>
      <div class="card-count">${gmailMessages.length}</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

// ‚îÄ‚îÄ OVERRIDE renderCalFull ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.renderCalFull = function() {
  if (!currentUser) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
      <div class="empty" style="padding:32px 20px">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–æ–±—ã—Ç–∏—è</div></div>`;
  }
  if (calEvents === null) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
      <div class="loading-row"><span class="spin">‚ü≥</span> –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è...</div></div>`;
  }
  if (calEvents.length === 0) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--green)"></div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
      <div class="empty">–°–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç üéâ</div></div>`;
  }
  const rows = calEvents.map(e => {
    const timeStr = e.allDay ? '–í–µ—Å—å –¥–µ–Ω—å' : `${e.start} ‚Äì ${e.end}`;
    const dur = (!e.allDay && e.start && e.end) ? calcDur(e.start, e.end) : '';
    const meetBtn = e.meetLink
      ? `<a href="${e.meetLink}" target="_blank" style="font-size:10px;color:var(--accent2);text-decoration:none;background:rgba(59,130,246,.1);padding:2px 8px;border-radius:10px;border:1px solid rgba(59,130,246,.2)">‚ñ∂ Meet</a>`
      : '';
    return `<div class="event-row">
      <div class="event-time">${timeStr}</div>
      <div class="event-bar" style="background:${e.color}"></div>
      <div class="event-info">
        <div class="event-title">${e.title}</div>
        <div class="event-meta">${e.attendees} —É—á–∞—Å—Ç–Ω.${e.location ? ' ¬∑ ' + e.location : ''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        ${meetBtn}
        ${dur ? `<div class="event-duration">${dur}</div>` : ''}
      </div>
    </div>`;
  }).join('');
  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--green)"></div>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–Ω—è</div>
      <div class="card-count">${calEvents.length} –≤—Å—Ç—Ä–µ—á</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

function calcDur(start, end) {
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  const mins = (eh * 60 + em) - (sh * 60 + sm);
  if (mins <= 0) return '';
  return mins >= 60 ? Math.floor(mins/60) + '—á' + (mins%60 ? ' ' + mins%60 + '–º' : '') : mins + '–º';
}

// ‚îÄ‚îÄ OVERRIDE renderTasksFull ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.renderTasksFull = function() {
  if (!currentUser) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="empty" style="padding:32px 20px">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∑–∞–¥–∞—á–∏</div></div>`;
  }
  if (realTasks === null) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="loading-row"><span class="spin">‚ü≥</span> –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏...</div></div>`;
  }
  if (realTasks.length === 0) {
    return `<div class="card"><div class="card-header"><div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div></div>
      <div class="empty">–ó–∞–¥–∞—á –Ω–µ—Ç üéâ</div></div>`;
  }
  const done  = taskState.filter(Boolean).length;
  const rows  = realTasks.map((t, i) => {
    const isDone = taskState[i];
    return `<div class="task-row">
      <div class="task-check ${isDone ? 'done' : ''}"></div>
      <div style="flex:1;min-width:0">
        <div class="task-text ${isDone ? 'done' : ''}">${t.text}</div>
        ${t.list ? `<div style="font-size:10px;color:var(--muted)">${t.list}</div>` : ''}
      </div>
      <div class="task-due ${t.overdue && !isDone ? 'overdue' : ''}">${t.due}</div>
    </div>`;
  }).join('');
  return `<div class="card">
    <div class="card-header">
      <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      <div class="card-count">${done}/${realTasks.length} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="card-body">${rows}</div>
  </div>`;
};

// ‚îÄ‚îÄ OVERRIDE renderJiraFull ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.renderJiraFull = function() {
  if (!jiraCfgSet()) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira –∑–∞–¥–∞—á–∏</div>
      </div>
      <div class="empty" style="padding:40px 20px">
        <div style="margin-bottom:12px;font-size:24px">üîß</div>
        <div style="margin-bottom:16px">–í–≤–µ–¥–∏—Ç–µ Jira credentials –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</div>
        <button class="btn-primary" onclick="openSettings()" style="font-size:11px;padding:9px 20px">‚öô –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>`;
  }
  if (jiraIssues === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira –∑–∞–¥–∞—á–∏</div>
      </div>
      <div class="loading-row"><span class="spin">‚ü≥</span> –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ Jira...</div>
    </div>`;
  }
  if (jiraIssues.length === 0) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--accent)"></div>Jira –∑–∞–¥–∞—á–∏</div>
      </div>
      <div class="empty">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç üéâ</div>
    </div>`;
  }

  const rows = jiraIssues.map(issue => `
    <div class="issue-row" data-status="${issue.status}" onclick="window.open('${issue.url}','_blank')" style="cursor:pointer">
      <div class="priority-dot ${priorityClass(issue.priority)}"></div>
      <div class="issue-key">${issue.key}</div>
      <div style="flex:1;min-width:0">
        <div class="issue-summary">${issue.summary}</div>
        <div class="issue-project">${issue.project} ¬∑ ${issue.updated}</div>
      </div>
      <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    </div>`).join('');

  // Count per group for tab badges
  const counts = { all: jiraIssues.length, inprogress: 0, review: 0, approval: 0, todo: 0, done: 0 };
  jiraIssues.forEach(j => { counts[jiraStatusGroup(j.status)]++; });

  const tabs = [
    { label: '–í—Å–µ',           count: counts.all,        group: null,         color: '' },
    { label: '–í —Ä–∞–±–æ—Ç–µ',      count: counts.inprogress, group: 'inprogress', color: '' },
    { label: '–†–µ–≤—å—é / –¢–µ—Å—Ç',  count: counts.review,     group: 'review',     color: '' },
    { label: '–ù–∞ –∞–ø—Ä—É–≤',      count: counts.approval,   group: 'approval',   color: 'color:var(--orange)' },
    { label: '–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é',  count: counts.todo,        group: 'todo',      color: '' },
    { label: '–ì–æ—Ç–æ–≤–æ',        count: counts.done,        group: 'done',      color: '' }
  ];

  return `
  <div class="tabs">
    ${tabs.map((t,i) => `
      <div class="tab${i===0?' active':''}${t.color?' style="'+t.color+'"':''}" onclick="filterJira(${i},this)">
        ${t.label}${t.count > 0 ? ` <span style="font-size:9px;background:var(--bg4);padding:1px 5px;border-radius:8px;margin-left:3px${t.color?';'+t.color:''}">${t.count}</span>` : ''}
      </div>`).join('')}
  </div>
  <div class="card" style="margin-top:16px" id="jiraList">
    ${rows}
  </div>`;
};

// ============================================================
//  PHASE 1: AUTO-REFRESH + NAV BADGES + MEETING ALERTS
// ============================================================

// ‚îÄ‚îÄ 1. Auto-refresh every 5 minutes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AUTO_REFRESH_MS = 5 * 60 * 1000;
let autoRefreshTimer  = null;

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(async () => {
    // Silent refresh ‚Äî don't show loading spinners, just update data
    const [gmailRes, calRes, tasksRes, jiraRes] = await Promise.allSettled([
      currentUser ? fetch('/api/gmail/messages').then(r=>r.json()) : Promise.resolve(null),
      currentUser ? fetch('/api/calendar/events').then(r=>r.json()) : Promise.resolve(null),
      currentUser ? fetch('/api/tasks/list').then(r=>r.json())     : Promise.resolve(null),
      jiraCfgSet() ? (() => {
        const cfg = JSON.parse(localStorage.getItem('drCfg')||'{}');
        return fetch('/api/jira/issues', {
          headers: { 'x-jira-domain': cfg.jiraDomain, 'x-jira-email': cfg.jiraEmail, 'x-jira-token': cfg.jiraToken }
        }).then(r=>r.json());
      })() : Promise.resolve(null)
    ]);

    if (gmailRes.value?.messages)  gmailMessages = gmailRes.value.messages;
    if (calRes.value?.events)      { calEvents = calRes.value.events; checkUpcomingMeetings(); }
    if (tasksRes.value?.tasks)     { realTasks = tasksRes.value.tasks; taskState = realTasks.map(t=>t.done); }
    if (jiraRes.value?.issues)     jiraIssues = jiraRes.value.issues;

    updateNavBadges();
    render();
    // Update last sync time quietly
    const now = new Date();
    const sync = document.getElementById('lastSync');
    if (sync) sync.textContent = '–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  }, AUTO_REFRESH_MS);
}

// ‚îÄ‚îÄ 2. Nav Badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateNavBadges() {
  // Gmail ‚Äî unread count
  const gmailBadge = document.getElementById('gmailBadge');
  if (gmailBadge && gmailMessages) {
    const unread = gmailMessages.filter(m=>m.unread).length;
    if (unread > 0) {
      gmailBadge.textContent = unread > 99 ? '99+' : unread;
      gmailBadge.style.display = 'inline-flex';
    } else {
      gmailBadge.style.display = 'none';
    }
  }

  // Jira ‚Äî in-progress count
  const jiraBadge = document.getElementById('jiraBadge');
  if (jiraBadge && jiraIssues) {
    const active = jiraIssues.filter(j =>
      j.status.toLowerCase().includes('progress') ||
      j.status.toLowerCase().includes('review') ||
      j.status.toLowerCase().includes('dev')
    ).length;
    if (active > 0) {
      jiraBadge.textContent = active;
      jiraBadge.style.display = 'inline-flex';
    } else {
      jiraBadge.style.display = 'none';
    }
  }

  // Calendar ‚Äî today's events count
  const calBadge = document.getElementById('calBadge');
  if (calBadge && calEvents) {
    const count = calEvents.length;
    if (count > 0) {
      calBadge.textContent = count;
      calBadge.style.display = 'inline-flex';
    } else {
      calBadge.style.display = 'none';
    }
  }
}

// ‚îÄ‚îÄ 3. Meeting Alerts (notify 10 min before) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const notifiedMeetings = new Set();

function checkUpcomingMeetings() {
  if (!calEvents) return;
  const now  = new Date();
  const soon = new Date(now.getTime() + 10 * 60 * 1000); // 10 min ahead

  calEvents.forEach(ev => {
    if (ev.allDay || !ev.start) return;

    const [h, m]  = ev.start.split(':').map(Number);
    const evTime  = new Date();
    evTime.setHours(h, m, 0, 0);

    const diffMs  = evTime - now;
    const diffMin = Math.round(diffMs / 60000);

    // Alert if meeting is 1‚Äì12 minutes away and not yet notified
    if (diffMin >= 1 && diffMin <= 12 && !notifiedMeetings.has(ev.id)) {
      notifiedMeetings.add(ev.id);
      showMeetingAlert(ev, diffMin);
    }
  });
}

let meetingAlertTimer = null;
function showMeetingAlert(ev, minsLeft) {
  const alert = document.getElementById('meetingAlert');
  document.getElementById('meetingAlertTitle').textContent = ev.title;
  document.getElementById('meetingAlertSub').textContent =
    `—á–µ—Ä–µ–∑ ${minsLeft} –º–∏–Ω ¬∑ ${ev.start}${ev.attendees > 1 ? ` ¬∑ ${ev.attendees} —É—á–∞—Å—Ç–Ω.` : ''}`;

  if (ev.meetLink) {
    document.getElementById('meetingAlertTitle').style.cursor = 'pointer';
    document.getElementById('meetingAlertTitle').onclick = () => window.open(ev.meetLink, '_blank');
  }

  alert.classList.add('show');
  if (meetingAlertTimer) clearTimeout(meetingAlertTimer);
  meetingAlertTimer = setTimeout(() => alert.classList.remove('show'), 15000);
}

function closeMeetingAlert() {
  document.getElementById('meetingAlert').classList.remove('show');
  if (meetingAlertTimer) clearTimeout(meetingAlertTimer);
}

// Check for meetings every 60 seconds
setInterval(() => { if (calEvents) checkUpcomingMeetings(); }, 60 * 1000);

// ‚îÄ‚îÄ 4. Make renderIssueRow Jira-clickable on dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origRenderIssueRow = renderIssueRow;
window.renderIssueRow = function(issue) {
  if (issue.url) {
    return `<div class="issue-row" onclick="window.open('${issue.url}','_blank')" style="cursor:pointer">
      <div class="priority-dot ${priorityClass(issue.priority)}"></div>
      <div class="issue-key">${issue.key}</div>
      <div style="flex:1;min-width:0">
        <div class="issue-summary" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${issue.summary}</div>
        <div class="issue-project">${issue.project}</div>
      </div>
      <span class="status-pill ${statusClass(issue.status)}">${statusLabel(issue.status)}</span>
    </div>`;
  }
  return _origRenderIssueRow(issue);
};

// Patch loadGmailMessages / loadCalendarEvents / loadTasks / loadJiraIssues
// to update badges after loading
const _origLoadGmail = loadGmailMessages;
window.loadGmailMessages = async function() {
  await _origLoadGmail();
  updateNavBadges();
};
const _origLoadCal = loadCalendarEvents;
window.loadCalendarEvents = async function() {
  await _origLoadCal();
  updateNavBadges();
  checkUpcomingMeetings();
};
const _origLoadTasks = loadTasks;
window.loadTasks = async function() {
  await _origLoadTasks();
};
const _origLoadJira = loadJiraIssues;
window.loadJiraIssues = async function() {
  await _origLoadJira();
  updateNavBadges();
};

// ‚îÄ‚îÄ 5. Override syncData to use patched loaders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.syncData = async function() {
  const btn  = document.getElementById('syncBtn');
  const sync = document.getElementById('lastSync');
  btn.classList.add('syncing');
  showToast('‚ü≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...');

  gmailMessages = null;
  calEvents     = null;
  realTasks     = null;
  jiraIssues    = null;
  render();

  await Promise.all([
    window.loadGmailMessages(),
    window.loadCalendarEvents(),
    window.loadTasks(),
    window.loadJiraIssues()
  ]);

  btn.classList.remove('syncing');
  const now = new Date();
  sync.textContent = '–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0');
  showToast('‚úì –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
  startAutoRefresh(); // reset timer after manual sync
};

// ============================================================
//  PHASE 3: LIGHT THEME + SKELETON LOADING
// ============================================================

// ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
  }
}

// ‚îÄ‚îÄ Skeleton rows helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function skeletonRows(n = 4) {
  return Array(n).fill(0).map((_, i) => `
    <div class="skeleton-row">
      <div class="skeleton skeleton-avatar"></div>
      <div class="skeleton-body">
        <div class="skeleton skeleton-line" style="width:${60 + (i % 3) * 15}%"></div>
        <div class="skeleton skeleton-line" style="width:${35 + (i % 2) * 20}%"></div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ Patch loading states to use skeletons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origRenderEmailFullSkel = window.renderEmailFull;
window.renderEmailFull = function(emailFilter) {
  emailFilter = emailFilter || window._emailFilter || 'all';

  if (currentUser && gmailMessages === null) {
    return `<div class="card">
      <div class="email-filter-tabs">
        <div class="email-filter-tab active">–í—Å–µ</div>
        <div class="email-filter-tab">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</div>
        <div class="email-filter-tab">–í–∞–∂–Ω—ã–µ</div>
      </div>
      <div class="card-body">${skeletonRows(4)}</div>
    </div>`;
  }
  if (!currentUser || !gmailMessages || gmailMessages.length === 0) {
    return _origRenderEmailFullSkel();
  }

  // Smart time formatting
  function smartTime(dateStr) {
    if (!dateStr) return '';
    const d   = new Date(dateStr);
    const now  = new Date();
    const pad  = n => String(n).padStart(2,'0');
    const todayStr = now.toDateString();
    const dStr     = d.toDateString();
    const yest     = new Date(now); yest.setDate(now.getDate()-1);
    if (dStr === todayStr)          return pad(d.getHours())+':'+pad(d.getMinutes());
    if (dStr === yest.toDateString()) return '–≤—á–µ—Ä–∞';
    const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
    return d.getDate()+' '+months[d.getMonth()];
  }

  // Filter messages
  const allMsgs   = gmailMessages;
  const unread    = allMsgs.filter(m=>m.unread);
  const starred   = allMsgs.filter(m=>m.starred);
  const displayed = emailFilter==='unread' ? unread : emailFilter==='starred' ? starred : allMsgs;

  const tabs = [
    { key:'all',     label:'–í—Å–µ',            count: allMsgs.length },
    { key:'unread',  label:'–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ',  count: unread.length },
    { key:'starred', label:'–í–∞–∂–Ω—ã–µ',         count: starred.length }
  ];

  const tabsHtml = `<div class="email-filter-tabs">
    ${tabs.map(t=>`
      <div class="email-filter-tab${emailFilter===t.key?' active':''}"
           onclick="window._emailFilter='${t.key}';render()">
        ${t.label}
        ${t.count > 0 ? `<span class="email-filter-count">${t.count}</span>` : ''}
      </div>`).join('')}
  </div>`;

  const avatarColors = ['#3b82f6','#a855f7','#22c55e','#f97316','#06b6d4','#ef4444','#ec4899'];

  const rows = displayed.map(m => {
    const initials = (m.from||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const color    = avatarColors[(m.from||'').charCodeAt(0) % avatarColors.length];
    const timeStr  = smartTime(m.date);
    const gmailUrl = `https://mail.google.com/mail/u/0/#inbox/${m.id}`;
    return `<div class="email-row${m.unread?' email-row-unread':''}" onclick="window.open('${gmailUrl}','_blank')" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Gmail">
      <div class="email-avatar" style="background:${color}20;color:${color}">${initials}</div>
      <div class="email-body">
        <div class="email-from${m.unread?' font-weight-600':''}">
          <span style="${m.unread?'font-weight:600':''}">${m.from}</span>
          <span class="email-addr">&lt;${m.email}&gt;</span>
        </div>
        <div class="email-subject" style="${m.unread?'color:var(--text);font-weight:500':''}">${m.subject}</div>
        ${m.snippet ? `<div class="email-snippet-2">${m.snippet}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;padding-left:8px">
        <div class="email-time" style="${m.unread?'color:var(--accent2)':''}">${timeStr}</div>
        ${m.starred ? '<div class="email-star">‚òÖ</div>' : ''}
        ${m.unread  ? '<div class="email-unread-dot"></div>' : ''}
      </div>
    </div>`;
  }).join('');

  const emptyHtml = displayed.length === 0
    ? `<div class="empty">${emailFilter==='unread'?'–ù–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø–∏—Å–µ–º üéâ':emailFilter==='starred'?'–ù–µ—Ç –≤–∞–∂–Ω—ã—Ö –ø–∏—Å–µ–º':'–í—Ö–æ–¥—è—â–∏–µ –ø—É—Å—Ç—ã'}</div>`
    : '';

  return `<div class="card">
    ${tabsHtml}
    <div class="card-body">${rows || emptyHtml}</div>
  </div>`;
};

const _origRenderCalFullSkel = window.renderCalFull;
window.renderCalFull = function(dayOffset) {
  // dayOffset: 0=today, 1=tomorrow, 7=week (show next 7 days)
  dayOffset = (typeof dayOffset !== 'undefined') ? dayOffset : (window._calDayOffset || 0);

  if (currentUser && calEvents === null) {
    return `<div class="card">
      <div class="cal-day-tabs">
        <div class="cal-day-tab active">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="cal-day-tab">–ó–∞–≤—Ç—Ä–∞</div>
        <div class="cal-day-tab">–ù–µ–¥–µ–ª—è</div>
      </div>
      <div class="card-body">${skeletonRows(3)}</div>
    </div>`;
  }

  // For tomorrow/week tabs we use demo DATA since we only fetched today
  // but if real calEvents available use them for today, demo for others
  const dayTabs = [
    { label: '–°–µ–≥–æ–¥–Ω—è', offset: 0 },
    { label: '–ó–∞–≤—Ç—Ä–∞',  offset: 1 },
    { label: '–ù–µ–¥–µ–ª—è',  offset: 7 }
  ];
  const tabsHtml = `<div class="cal-day-tabs">
    ${dayTabs.map(t=>`
      <div class="cal-day-tab${dayOffset===t.offset?' active':''}"
           onclick="window._calDayOffset=${t.offset};render()">
        ${t.label}
      </div>`).join('')}
  </div>`;

  if (!currentUser) {
    return `<div class="card">${tabsHtml}
      <div class="empty" style="padding:32px 20px">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–æ–±—ã—Ç–∏—è</div></div>`;
  }

  // Use real events for today, demo for other days
  const events = (dayOffset === 0 && calEvents) ? calEvents : DATA.events;

  if (events.length === 0) {
    return `<div class="card">${tabsHtml}
      <div class="empty">–í—Å—Ç—Ä–µ—á –Ω–µ—Ç üéâ</div></div>`;
  }

  // Helper: time string "HH:MM" ‚Üí minutes since midnight
  function toMin(t) {
    if (!t || !t.includes(':')) return -1;
    const [h,m] = t.split(':').map(Number);
    return h*60+m;
  }

  // Current time in minutes
  const now    = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();

  // Separate all-day events
  const allDayEvts = events.filter(e => e.allDay || !e.start || !e.start.includes(':'));
  const timedEvts  = events.filter(e => !e.allDay && e.start && e.start.includes(':'));

  const allDayHtml = allDayEvts.map(e => `
    <div class="timeline-allday">
      <div class="timeline-allday-bar" style="background:${e.color||'#3b82f6'}"></div>
      <span>${e.title}</span>
      <span style="margin-left:auto;font-size:10px;color:var(--muted)">–≤–µ—Å—å –¥–µ–Ω—å</span>
    </div>`).join('');

  const eventsHtml = timedEvts.map(e => {
    const startMin = toMin(e.start);
    const endMin   = toMin(e.end);
    const isCurrent = dayOffset===0 && startMin>=0 && endMin>0 && nowMin>=startMin && nowMin<endMin;
    const isSoon    = dayOffset===0 && startMin>=0 && startMin>nowMin && startMin-nowMin<=15;
    const isPast    = dayOffset===0 && endMin>0 && nowMin>=endMin;

    let badge = '';
    if (isCurrent) badge = `<span class="timeline-card-badge badge-now">‚óè –°–ï–ô–ß–ê–°</span>`;
    else if (isSoon) badge = `<span class="timeline-card-badge badge-soon">—á–µ—Ä–µ–∑ ${startMin-nowMin} –º–∏–Ω</span>`;
    else if (isPast) badge = `<span class="timeline-card-badge badge-done">‚úì –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>`;

    // Progress bar for ongoing meeting
    let progressHtml = '';
    if (isCurrent && endMin>startMin) {
      const pct = Math.round(((nowMin-startMin)/(endMin-startMin))*100);
      progressHtml = `<div class="timeline-progress-wrap">
        <div class="timeline-progress-bar" style="width:${pct}%"></div>
      </div>
      <div style="font-size:9px;color:var(--muted2);margin-top:4px">
        ${pct}% ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å ${endMin-nowMin} –º–∏–Ω
      </div>`;
    }

    const dur = (e.start && e.end) ? calcDur(e.start, e.end) : '';
    const attendeesStr = e.attendees > 1 ? `${e.attendees} —É—á–∞—Å—Ç–Ω.` : '';
    const locationStr  = e.location ? ` ¬∑ ${e.location}` : '';
    const meetBtn = e.meetLink
      ? `<a href="${e.meetLink}" target="_blank" onclick="event.stopPropagation()"
           style="font-size:9px;color:var(--accent2);text-decoration:none;background:rgba(59,130,246,.1);padding:2px 8px;border-radius:8px;border:1px solid rgba(59,130,246,.2)">‚ñ∂ Meet</a>`
      : '';

    const dotColor = isCurrent ? (e.color||'#3b82f6') : (isPast ? '#64748b' : (e.color||'#3b82f6'));

    return `<div class="timeline-event">
      <div class="timeline-time">${e.start}</div>
      <div class="timeline-dot-wrap">
        <div class="timeline-dot" style="border-color:${dotColor};${isCurrent?'background:'+dotColor:isPast?'background:var(--bg4)':''}"></div>
      </div>
      <div class="timeline-card${isCurrent?' current':''}" style="opacity:${isPast?.55:1};--ev-color:${e.color||'#3b82f6'}">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div class="timeline-card-title">${e.title}</div>
          <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
            ${badge}
            ${meetBtn}
          </div>
        </div>
        <div class="timeline-card-meta">
          ${e.start}${e.end?' ‚Äì '+e.end:''} ${dur?'¬∑ '+dur:''}
          ${attendeesStr ? '¬∑ '+attendeesStr : ''}${locationStr}
        </div>
        ${progressHtml}
      </div>
    </div>`;
  }).join('');

  const dayLabel = dayOffset===0 ? '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Å–µ–≥–æ–¥–Ω—è'
                 : dayOffset===1 ? '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –∑–∞–≤—Ç—Ä–∞'
                 : '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –Ω–µ–¥–µ–ª—è';

  return `<div class="card">
    ${tabsHtml}
    <div style="padding:16px 20px 4px;display:flex;align-items:center;justify-content:space-between">
      <div style="font-family:'Syne',sans-serif;font-weight:600;font-size:13px;color:var(--text)">${dayLabel}</div>
      <div style="font-size:11px;color:var(--muted)">${events.length} —Å–æ–±—ã—Ç–∏–π</div>
    </div>
    <div class="timeline-wrap">
      <div class="timeline-line"></div>
      ${allDayHtml}
      ${eventsHtml}
    </div>
  </div>`;
};

const _origRenderTasksFullSkel = window.renderTasksFull;
window.renderTasksFull = function() {
  if (currentUser && realTasks === null) {
    return `<div class="card">
      <div class="card-header">
        <div class="card-title"><div class="dot" style="background:var(--purple)"></div>Google Tasks</div>
      </div>
      <div class="card-body">${skeletonRows(4)}</div>
    </div>`;
  }
  return _origRenderTasksFullSkel();
};

const _origRenderJiraFullSkel = window.renderJiraFull;
window.renderJiraFull = function() {
  if (jiraCfgSet() && jiraIssues === null) {
    return `
    <div class="tabs">
      ${['–í—Å–µ','–í —Ä–∞–±–æ—Ç–µ','–†–µ–≤—å—é / –¢–µ—Å—Ç','–ù–∞ –∞–ø—Ä—É–≤','–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é','–ì–æ—Ç–æ–≤–æ'].map((t,i)=>
        `<div class="tab${i===0?' active':''}${t==='–ù–∞ –∞–ø—Ä—É–≤'?' style="color:var(--orange)"':''}">${t}</div>`).join('')}
    </div>
    <div class="card" style="margin-top:16px">
      <div class="card-body">${skeletonRows(5)}</div>
    </div>`;
  }
  return _origRenderJiraFullSkel();
};

// ‚îÄ‚îÄ Telegram Report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendTelegramReport() {
  const cfg = JSON.parse(localStorage.getItem('drCfg') || '{}');
  if (!cfg.tgToken || !cfg.tgChatId) {
    showToast('‚ö† –£–∫–∞–∂–∏—Ç–µ Telegram Bot Token –∏ Chat ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
    openSettings();
    return;
  }

  const btn = document.getElementById('tgBtn');
  btn.classList.add('syncing');
  showToast('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç...');

  try {
    const res = await fetch('/api/telegram/report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tgToken:   cfg.tgToken,
        tgChatId:  cfg.tgChatId,
        jiraDomain: cfg.jiraDomain,
        jiraEmail:  cfg.jiraEmail,
        jiraToken:  cfg.jiraToken
      })
    });
    const data = await res.json();
    if (data.ok) {
      showToast('‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!');
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (err) {
    showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç');
  } finally {
    btn.classList.remove('syncing');
  }
}

// Handle ?auth=success redirect
if (new URLSearchParams(location.search).get('auth') === 'success') {
  history.replaceState({}, '', '/');
}

// ============================================================
//  INIT
// ============================================================
initTheme();
document.getElementById('pageDate').textContent = fmt(currentDate);
render();
checkAuth();
startAutoRefresh();
setTimeout(updateNavBadges, 4000);
</script>
</body>
</html>
```